---
lab:
  title: 实验室：使用映像模板创建自定义会话主机映像
  module: 'Module 1.5: Create and manage session host images'
---

# 实验室 - 使用映像模板创建自定义会话主机映像
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft Entra 帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者角色，并且具有将设备加入与该 Azure 订阅关联的 Entra 租户的足够权限。

## 估计时间

90 分钟（大约 45 分钟是完成映像构建的等待时间）

## 实验室方案

你计划实现 Azure 虚拟桌面环境。 部署 Azure 虚拟桌面会话主机时，需要使用自定义虚拟机映像。

## 目标
  
完成本实验室后，你将能够：

- 使用映像模板为 Azure 虚拟桌面创建自定义会话主机映像

## 实验室文件

- 无

## 说明

### 练习 1：使用映像模板创建自定义会话主机映像

此练习的主要任务如下：

1. 注册所需的资源提供程序
1. 创建用户分配的托管标识
1. 创建 Azure 基于角色的访问控制 (RBAC) 自定义角色。
1. 设置对主机映像预配相关资源的权限
1. 创建 Azure Compute Gallery 实例和映像定义
1. 创建自定义映像模板
1. 构建自定义映像
1. 使用自定义映像部署会话主机

> **注意**：在创建自定义映像模板之前，需要满足许多先决条件，包括：

- 注册所有必需的资源提供程序
- 创建用户分配的托管标识
- 使用 Azure 基于角色的访问控制 (RBAC) 自定义角色授予用户分配的托管标识所需的权限。
- 如果打算使用 Azure Compute Gallery 分发映像，则必须创建其实例以及映像定义

#### 任务 1：注册所需的资源提供程序

1. 如果需要，在实验室计算机上，启动 Web 浏览器，导航到 Azure 门户，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。

    > **备注**：使用实验室会话窗口右侧“资源”选项卡上列出的 `User1-` 帐户的凭据。

1. 在 Azure 门户的 Azure Cloud Shell 中，启动一个 PowerShell 会话。

    > **备注**：如果出现提示，请在“**入门**”窗格中的“**订阅**”下拉列表中，选择正在本实验室中使用的 Azure 订阅的名称，然后选择“**应用**”。

1. 在 Azure Cloud Shell 窗格的 PowerShell 会话中，运行以下命令以注册 **Microsoft.DesktopVirtualization** 资源提供程序：

    ```powershell
    Register-AzResourceProvider -ProviderNamespace Microsoft.DesktopVirtualization
    Register-AzResourceProvider -ProviderNamespace Microsoft.VirtualMachineImages
    Register-AzResourceProvider -ProviderNamespace Microsoft.Storage
    Register-AzResourceProvider -ProviderNamespace Microsoft.Compute
    Register-AzResourceProvider -ProviderNamespace Microsoft.Network
    Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault
    Register-AzResourceProvider -ProviderNamespace Microsoft.ContainerInstance
    ```

    > **备注**：请勿等待注册完成。 这可能需要大约 5 分钟。

1. 关闭 Azure Cloud Shell 窗格。

#### 任务 2：创建用户分配的托管标识

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器中，搜索并选择“**托管标识**”。
1. 在“托管标识”页上，选择“+ 创建”********。
1. 在“**创建用户分配的托管标识**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**查看 + 创建**”：

    > **注意**：设置“**名称**”值时，切换到实验室会话窗口右侧的“资源”选项卡，并标识 *User1-* 和 *@* 字符之间的字符字符串。 使用此字符串替换 *random* 占位符。

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组名称 **az140-15a-RG**|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |名称|**az140**-*random*-**uami**|

1. 在“查看 + 创建”选项卡上，选择“创建”。********

    >**注意**：请勿等待用户分配的托管标识预配完成。 这应该只需要几秒钟时间。

#### 任务 3：创建 Azure 基于角色的访问控制 (RBAC) 自定义角色。

>**注意**：Azure 基于角色的访问控制 (RBAC) 自定义角色将用于把适当的权限分配给在上一任务中创建的用户分配的托管标识。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器中，开启 Azure Cloud Shell 中的 PowerShell 会话。

1. 在 Azure Cloud Shell 窗格的 PowerShell 会话中，运行以下命令以标识用于此实验室的 Azure 订阅的 **ID** 属性的值，并将其存储在 **$subscriptionId** 变量中：

    ```powershell
    $subscriptionId = (Get-AzSubscription).Id
    ```

1. 运行以下命令以创建新自定义角色的角色定义，包括其可分配的范围值并将其存储在 **$jsonContent** 变量中（请确保将 *随机*占位符替换为在上一个任务中标识的相同字符串）：

    ```powershell
    $jsonContent = @"
    {
      "Name": "Desktop Virtualization Image Creator (random)",
      "IsCustom": true,
      "Description": "Create custom image templates for Azure Virtual Desktop images.",
      "Actions": [
        "Microsoft.Compute/galleries/read",
        "Microsoft.Compute/galleries/images/read",
        "Microsoft.Compute/galleries/images/versions/read",
        "Microsoft.Compute/galleries/images/versions/write",
        "Microsoft.Compute/images/write",
        "Microsoft.Compute/images/read",
        "Microsoft.Compute/images/delete"
      ],
      "NotActions": [],
      "DataActions": [],
      "NotDataActions": [],
      "AssignableScopes": [
        "/subscriptions/$subscriptionId",
        "/subscriptions/$subscriptionId/resourceGroups/az140-15b-RG"
      ]
    }
    "@
    ```

1. 运行以下命令，将 **$jsonContent** 变量的内容存储在名为 **CustomRole.json** 的文件中：

    ```powershell
    $jsonContent | Out-File -FilePath 'CustomRole.json'
    ```

1. 运行以下命令，创建自定义角色：

    ```powershell
    New-AzRoleDefinition -InputFile ./CustomRole.json
    ```

1. 关闭 Azure Cloud Shell 窗格。

#### 任务 4：设置主机映像预配相关资源的权限

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器中，搜索并选择“**资源组**，”然后在“**资源组**”页上选择“**+ 创建**”。
1. 在“**创建资源组**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**查看 + 创建**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新建资源组名称 **az140-15b-RG**|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“查看 + 创建”选项卡上，选择“创建”。********
1. 刷新“**资源组**”页，并在资源组列表中选择 **az140-15b-RG**。
1. 在 **az140-15b-RG** 页上的垂直导航菜单中，选择“**访问控制 (IAM)**”。
1. 在“**az140-15b-RG\|访问控制 (IAM)**”页上，选择“**+ 添加**”，然后从下拉菜单中选择“**添加角色分配**”。
1. 在“**添加角色分配**”页的“**角色**”选项卡上，确保选中“**工作职能角色**”选项卡，在搜索文本框中输入“**桌面虚拟化图像创建器** (*random*)”，在结果列表中选择“**桌面虚拟化图像创建器** (*random*)”，然后选择“**下一步**”。

    >**注意**：请确保将 *random* 占位符替换为定义新的自定义 RBAC 角色时使用的字符串。

1. 在“**添加角色分配**”页的“**成员**”选项卡上，选择“**托管标识**”选项，单击“**+选择成员**”，在“**选择托管标识**”窗格中，从“**托管标识**”下拉列表中选择“**用户分配的托管标识**”，在“用户分配的托管标识”列表中选择“**az140**-*random*-**uami**”（其中 *random* 占位符表示定义新的自定义 RBAC 角色时使用的相同字符串），然后单击“**选择**”。
1. 返回到“**添加角色分配**”页面的“**成员**”选项卡上，选择“**审阅 + 分配**”。
1. 在“查看 + 分配”**** 选项卡上，选择“查看 + 分配”****。 

#### 任务 5：创建 Azure Compute Gallery 实例和映像定义

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure Compute Gallery**”，然后在“**Azure Compute Gallery**”页上选择“**+ 创建**”。
1. 在“**创建 Azure Compute Gallery**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**下一步 : 共享方法**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-15b-RG**|
    |名称|**az14015computegallery**|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“**创建 Azure Compute Gallery**”页的“**共享**”选项卡上，保持默认选项“**基于角色的访问控制 (RBAC)**”为选中状态，然后选择“**查看+创建**”。
1. 在“查看 + 创建”选项卡上，选择“创建”。********

    >**注意**：等待预配过程完成。 此过程应该会在 1 分钟内完成。

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure Compute Gallery**”，然后在“**Azure Compute Gallery**”页上选择“**az14015computegallery**”。 
1. 在“**az14015computegallery**”页上，选择“**+ 添加**”，然后在下拉菜单中选择“**+ VM 映像定义**”。 
1. 在“**创建 VM 映像定义**”页的“**基本信息**”选项卡中，指定以下设置（保留其他设置为默认值），然后选择“**下一步: 版本**”：

    |设置|值|
    |---|---|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |VM 映像定义名称|**az14015imagedefinition**|
    |OS 类型|**Windows**|
    |安全类型|**支持受信任启动**|
    |OS 状态|**通用**|
    |发布者|**MicrosoftWindowsDesktop**|
    |产品/服务|**Windows-11**|
    |SKU|**win11-23h2-avd-m365**|

    > **备注**：VM 生成会自动设置为 Gen2，因为“受信任”和“机密”安全类型不支持第 1 代虚拟机。

1. 在“**创建 VM 映像定义**”页的“**版本**”选项卡上，保留设置不变，然后选择“**下一步: 发布选项**”。

    > **备注**：不应在此阶段创建 VM 映像版本。 这将由 Azure 虚拟桌面完成。

1. 在“**创建 VM 映像定义**”页的“**发布选项**”选项卡上，保留设置不变，然后选择“**查看 + 创建**”。
1. 在“**创建 VM 映像定义**”页的“**查看 + 创建**”选项卡上，选择“**创建**”。

    > **注意**：等待预配过程完成。 这通常需要不到 1 分钟。

#### 任务 6：创建自定义映像模板

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单中的“**管理**”部分中，选择“**自定义映像模板**”，然后在“**Azure 虚拟桌面 \| 自定义映像模板**”页上，选择“**+添加自定义映像模板**”。 
1. 在“**创建自定义映像模板**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步**”：

    > **备注**：设置“**托管标识**”属性时，确保将 *random* 占位符替换为本练习前面标识的相同字符串。

    |设置|“值”|
    |---|---|
    |模板名称|**az140-15b-imagetemplate**|
    |从现有模板导入|**否**|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-15b-RG**|
    |位置|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |托管的标识|**az140**-*random*-**uami**|

1. 在“**创建自定义映像模板**”页的“**源映像**”选项卡上，指定以下设置，然后选择“**下一步**” ：

    |设置|值|
    |---|---|
    |源类型|**平台映像（市场）**|
    |选择映像|**Windows 11 企业版多会话版本 23H2 + Microsoft 365 应用版**|

1. 在“**创建自定义映像模板**”页的“**分配目标**”选项卡上，指定以下设置（将其他设置保留为默认值）并选择“**下一步**”：

    |设置|“值”|
    |---|---|
    |Azure Compute Gallery|enabled|
    |库名称|**az14015computegallery**|
    |库映像定义|**az14015imagedefinition**|
    |库映像版本|**1.0.0**|
    |运行输出名称|**az140-15-image-1.0.0**|
    |复制区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |从最新版本中排除|**否**|
    |存储帐户类型|**Standard_LRS**|

    > **注意**：可以使用“**复制区域**”属性来适应多区域构建。 将“**从最新版本中排除**”设置为“**是**”可防止在创建虚拟机期间将“**latest**”指定为 **ImageReference** 元素的版本时使用此映像版本。

1. 在“**创建自定义映像模板**”页的“**生成属性**”选项卡上，指定以下设置（将其他设置保留为默认值），然后选择“**下一步**”：

    |设置|“值”|
    |---|---|
    |生成超时|**120**|
    |生成 VM 大小|**Standard_DC2s_v3**|
    |OS 磁盘大小 (GB)|**127**|
    |暂存组|**az140-15c-RG**|
    |VNet|保留未设置|

    > **注意**：**暂存组**是用于暂存资源以生成映像和存储日志的资源组。 如果你未提供名称，则会自动生成一个名称。 如果未设置 **VNet** 名称，则会创建一个临时名称，以及用于创建生成的 VM 的公共 IP 地址。

    > **重要说明**：确保有足够数量的可用 vCPU 来满足您指定的 Build VM 大小。 如果没有，请选择不同的大小或请求增加配额。

1. 在“**创建自定义映像模板**”页的“**自定义**”选项卡上，选择“**+ 添加内置脚本**”。 
1. 在“**选择内置脚本**”窗格中，查看分组到特定于操作系统的脚本、Azure 虚拟桌面脚本、MSIX 应用附加脚本、应用程序脚本和Windows 更新相关脚本中的可用选项，然后选择以下条目：

   - **时区重定向**：允许客户端在会话主机上的会话中使用其时区
   - **禁用存储感知**：防止存储感知误检测出可用磁盘空间较低的情况，进而对会话主机产生负面影响
   - 通过**在客户端和服务器上屏蔽屏幕捕获****启用屏幕捕获保护**：阻止或隐藏屏幕截图和屏幕共享中远程内容

1. 在“**选择内置脚本**”窗格中，选择“**保存**”。

    > **备注**：可以选择添加自己的脚本。 例如，请考虑引用内置脚本，例如[时区重定向](https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/TimezoneRedirection.ps1)、[禁用存储感知](https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/DisableStorageSense.ps1)或[启用屏幕捕获保护](https://raw.githubusercontent.com/Azure/RDS-Templates/master/CustomImageTemplateScripts/CustomImageTemplateScripts_2024-03-27/ScreenCaptureProtection.ps1)。

1. 返回到“**创建自定义映像模板**”页的“**自定义**”选项卡，选择“**下一步**”。
1. 在“**创建自定义映像模板**”页的“**标记**”选项卡上，选择“**下一步**”。
1. 在“**创建自定义映像模板**”页的“**查看 + 创建**”选项卡上，选择“**创建**”。

    > **备注**：等待模板创建完成。 这可能需要几分钟的时间。 刷新“**Azure 虚拟桌面 \| 自定义映像模板**”页以查看模板状态。

#### 任务 7：生成自定义 VM 映像

> **备注**：此实验室的剩余任务是可选的，因为其中会有相当长的等待时间。 

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中的“**Azure 虚拟桌面 \| 自定义映像模板**”页上，选择“**az140-15b-imagetemplate**”。
1. 在“**az140-15b-imagetemplate**”页上，选择“**启动内部版本**”。

    > **备注**：请等到内部版本创建完成。 完成生成过程的实际时间可能会有所不同，但按照实验室说明中提供的设置，应在 45 分钟内完成。 每隔几分钟刷新一次页面，并在“**az140-15b-imagetemplate**”页的“**Essentials**”部分中监视“**内部版本运行状态**”值。 

    > **备注**：内部版本运行状态应在某个时刻从“**正在运行 - 生成**”更改为“**正在运行 - 分发**”，最后更改为“**成功**”。

    > **备注**：等待内部版本完成时，请查看暂存资源组 **az140-15c-RG** 的内容，内部版本资源将自动预配，其中包括内部版本虚拟机、虚拟网络、网络安全组、密钥保管库、快照、容器实例和存储帐户。 

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**资源组**”，然后在“**资源组**”页上选择“**az140-15c-RG**”。
1. 在“**az140-15c-RG**”页上的“**资源**”部分中，注意自动预配的资源。
1. 返回到“**az140-15b-imagetemplate**”页并监视生成进度。 

    > **备注**：或者，可以使用**活动日志**跟踪生成过程的完成情况。 应关注的操作是**执行 VM 映像模板以生成其输出**。 其状态应在某个时刻从“**已接受**”更改为“**成功**”。

1. 生成完成后，在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure Compute Gallery**”，然后在“**Azure Compute Gallery**”页上选择“**az14015computegallery**”。 
1. 在“**az14015computegallery**”上的“**定义**”选项卡上，选择“**az14015imagedefinition**”。
1. 在“**az14015imagedefinition**”页上的“**版本**”选项卡上，查看有关 **1.0.0（最新版本）** 映像的信息。

#### 任务 8：使用自定义映像部署会话主机

> **备注**：（可选）请考虑使用创建的自定义映像逐步完成部署 Azure 虚拟桌面会话主机的初始阶段。 

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**虚拟网络**”，然后在“**虚拟网络**”页中选择“**创建 +**”
1. 在“创建虚拟机”页的“基本信息”选项卡中，指定以下设置并选择“下一页:************

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组的名称 **az140-15d-RG**|
    |虚拟网络名称|**az140-vnet15d**|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“安全性”选项卡上，接受默认设置并选择“下一步”。********
1. 在“**IP 地址**”选项卡上，指定以下设置：

    |设置|“值”|
    |---|---|
    |IP 地址空间|**10.30.0.0/16**|

1. 选择**默认**子网条目旁边的编辑（铅笔）图标，在“**编辑**”窗格中指定以下设置（其他设置保留现有值），然后选择“**保存**”：

    |设置|值|
    |---|---|
    |名称|hp1-Subnet|
    |开始地址|**10.30.1.0**|
    |启用专用子网（无默认出站访问）|已禁用|

1. 回到“**IP 地址**”选项卡，选择“**查看 + 创建**”，然后选择“**创建**”。

    > **注意**：等待预配过程完成。 这通常需要不到 1 分钟。

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单部分的“**管理**”中，选择“**主机池**”，然后在“**Azure 虚拟桌面 \| 主机池**”页上，选择“**+创建**”。 
1. 在“**创建主机池**”页的“**基本信息**”选项卡上，指定以下设置并选择“**下一步: 会话主机 >”**（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-15d-RG**|
    |主机池名称|**az140-15-hp1**|
    |位置|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |验证环境|**否**|
    |首选应用组类型|**桌面**|
    |主机池类型|**池**|
    |创建会话主机配置|**否**|
    |负载均衡算法|**广度优先**|

    > **备注**：在使用广度优先负载均衡算法时，最大会话限制参数是可选的。

1. 在“**创建主机池**”页的“**会话主机**”选项卡中，指定以下设置（将其他设置保留为默认值）：

    > **备注**：设置“**名称前缀**”值时，切换到实验室会话窗口右侧的“资源”选项卡，并标识 *User1-* 和 *@* 字符之间的字符串。 使用此字符串替换 *random* 占位符。

    |设置|“值”|
    |---|---|
    |添加虚拟机|**是**|
    |资源组|默认与主机池相同|
    |名称前缀|**sh0**_random_|
    |虚拟机类型|**Azure 虚拟机**|
    |虚拟机位置|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |可用性选项|**没有所需的基础结构冗余**|
    |安全类型|**受信任启动虚拟机**|

1. 在“**创建主机池**”页的“**虚拟机**”选项卡上，选择“**映像**”下拉列表下的“**查看所有映像**”。
1. 在“**选择映像**”页上，选择“**共享映像**”，然后在映像列表中选择 **az14015imagedefinition**。 
1. 回到“**创建主机池**”页面的“**虚拟机**”选项卡，指定以下设置并选择“**下一步 : 工作区 >**”（其他设置保留默认值）：

    |设置|“值”|
    |---|---|
    |虚拟机大小|**标准 DC2s_v3**|
    |VM 数量|**1**|
    |OS 磁盘类型|**标准 SSD**|
    |OS 磁盘大小|**默认大小 (128GiB)**|
    |启动诊断|使用托管存储帐户启用（推荐）|
    |虚拟网络|az140-vnet15d|
    |子网|hp1-Subnet|
    |网络安全组|**基本**|
    |公共入站端口|**否**|
    |选择要加入的目录|**Microsoft Entra ID**|
    |使用 Intune 注册 VM|**否**|
    |用户名|**学生**|
    |密码|将用作内置 Administrator 帐户密码的任何足够复杂的字符串|
    |确认密码|与之前指定的字符串相同|

    > **备注**：密码长度应至少为 12 个字符，由小写字符、大写字符、数字和特殊字符组合而成。 有关详细信息，请参阅[创建 Azure VM 时的密码要求](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)。

1. 在“**创建主机池**”页的“**工作区**”选项卡中，确认以下设置并选择“**查看 + 创建**”：

    |设置|Value|
    |---|---|
    |注册桌面应用组|**否**|

1. 在“**创建主机池**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > 备注：请等待部署完成。 这可能需要大约 10-15 分钟。
