---
lab:
  title: 实验室：使用 Azure 门户 (Entra ID) 部署主机池和会话主机
  module: 'Module 1.4: Implement host pools and session hosts'
---

# 实验室 - 使用 Azure 门户 (Entra ID) 部署主机池和会话主机
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft Entra 帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者角色，并且具有将设备加入与该 Azure 订阅关联的 Entra 租户的足够权限。

## 预计用时

30 分钟

## 实验室方案

拥有 Microsoft Azure 订阅。 需要部署使用已加入 Microsoft Entra 的会话主机的 Azure 虚拟桌面环境。

## 目标
  
完成本实验室后，你将能够：

- 部署已加入 Microsoft Entra 的 Azure 虚拟桌面会话主机

## 实验室文件

- 无

## 说明

### 练习 1：使用已加入 Microsoft Entra 的会话主机 实现 Azure 虚拟桌面环境
  
此练习的主要任务如下：

1. 准备 Azure 订阅，以部署 Azure 虚拟桌面主机池
1. 部署 Azure 虚拟桌面主机池
1. 创建 Azure 虚拟桌面应用程序组
1. 创建 Azure 虚拟桌面工作区
1. 允许访问 Azure 虚拟桌面主机池

#### 任务 1：准备 Azure 订阅，以部署 Azure 虚拟桌面主机池

1. 在实验室计算机上，启动 Web 浏览器，导航到位于 [https://portal.azure.com](https://portal.azure.com) 的 Azure 门户，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。

    > **备注**：使用实验室会话窗口右侧“资源”选项卡上列出的 `User1-` 帐户的凭据。

1. 在 Azure 门户的 Azure Cloud Shell 中，启动一个 PowerShell 会话。

    > **备注**：如果出现提示，请在“**入门**”窗格中的“**订阅**”下拉列表中，选择正在本实验室中使用的 Azure 订阅的名称，然后选择“**应用**”。

1. 在 Azure Cloud Shell 窗格的 PowerShell 会话中，运行以下命令以注册 **Microsoft.DesktopVirtualization** 资源提供程序：

    ```powershell
    Register-AzResourceProvider -ProviderNamespace Microsoft.DesktopVirtualization
    ```

    > **备注**：请勿等待注册完成。 这可能需要几分钟。

1. 关闭 Cloud Shell 窗格。
1. 在显示 Azure 门户的 Web 浏览器中，搜索并选择“**虚拟网络**”，然后在“**虚拟网络**”页上，选择“**创建 +**”
1. 在“创建虚拟机”页的“基本信息”选项卡中，指定以下设置并选择“下一页:************

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组名称为 **az140-11e-RG**|
    |虚拟网络名称|**az140-vnet11e**|
    |区域|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“安全性”选项卡上，接受默认设置并选择“下一步”。********
1. 在“**IP 地址**”选项卡上，指定以下设置：

    |设置|“值”|
    |---|---|
    |IP 地址空间|**10.20.0.0/16**|

1. 选择**默认**子网条目旁边的编辑（铅笔）图标，在“**编辑**”窗格中指定以下设置（其他设置保留现有值），然后选择“**保存**”：

    |设置|值|
    |---|---|
    |名称|hp1-Subnet|
    |开始地址|**10.20.1.0**|
    |启用专用子网（无默认出站访问）|已禁用|

1. 返回“**IP 地址**”选项卡，选择“**查看 + 创建**”，在“**查看 + 创建**”选项卡上，选择“**创建**”。

    > **备注**：请勿等待预配过程完成。 这通常需要不到 1 分钟。

1. 在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Microsoft Entra ID**”。
1. 在与订阅关联的 Microsoft Entra 租户的“**概述**”页上，在垂直导航菜单的“**管理**”部分中，选择“**用户**”。
1. 在“**用户**”页上的“**搜索**”文本框中，输入实验室会话窗口右侧的“资源”选项卡上列出的帐户的名称 `User1-`。
1. 在搜索结果列表中，选择具有匹配名称的用户帐户条目。
1. 在显示用户帐户属性的页面上，在垂直导航菜单的“**管理**”部分中，选择“**组**”。
1. 在“**组”** 页上，记录以 **AVD-DAG** 前缀开头的组的名称（稍后在本实验室中将用到）。
1. 导航回到“**用户**”页，在“**搜索**”文本框中，输入实验室会话窗口右侧的“资源”选项卡上列出的帐户的名称 `User2-`。
1. 在搜索结果列表中，选择具有匹配名称的用户帐户条目。
1. 在显示用户帐户属性的页面上，在垂直导航菜单的“**管理**”部分中，选择“**组**”。
1. 在“**组**”页上，记录以 **AVD-RemoteApp** 前缀开头的组的名称（稍后在本实验室中将用到）。

#### 任务 2：部署 Azure 虚拟桌面主机池

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单部分的“**管理**”中，选择“**主机池**”，然后在“**Azure 虚拟桌面 \| 主机池**”页上，选择“**+创建**”。 
1. 在“**创建主机池**”页的“**基本信息**”选项卡上，指定以下设置并选择“**下一步: 会话主机 >”**（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组名称为 **az140-21e-RG**|
    |主机池名称|az140-21-hp1|
    |位置|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |验证环境|**否**|
    |首选应用组类型|**桌面**|
    |主机池类型|**池**|
    |创建会话主机配置|**否**|
    |负载均衡算法|**广度优先**|

    > **备注**：在使用广度优先负载均衡算法时，最大会话限制参数是可选的。

1. 在“**创建主机池**”页的“**会话主机**”选项卡中，指定以下设置并选择“**下一步: 工作区 >**”（将其他设置保留为默认值）：

    > **备注**：设置“**名称前缀**”值时，切换到实验室会话窗口右侧的“资源”选项卡，并标识 *User1-* 和 *@* 字符之间的字符串。 使用此字符串替换 *random* 占位符。

    |设置|“值”|
    |---|---|
    |添加虚拟机|**是**|
    |资源组|默认与主机池相同|
    |名称前缀|**sh**-*random*|
    |虚拟机类型|**Azure 虚拟机**|
    |虚拟机位置|要在其中部署 Azure 虚拟桌面环境的 Azure 区域的名称|
    |可用性选项|**没有所需的基础结构冗余**|
    |安全类型|**受信任启动虚拟机**|
    |映像|**Windows 11 企业版多会话版本 23H2 + Microsoft 365 应用版**|
    |虚拟机大小|**标准 DC2s_v3**|
    |VM 数量|**2**|
    |OS 磁盘类型|**标准 SSD**|
    |OS 磁盘大小|**默认大小 (128GiB)**|
    |启动诊断|使用托管存储帐户启用（推荐）|
    |虚拟网络|**az140-vnet11e**|
    |子网|hp1-Subnet|
    |网络安全组|**基本**|
    |公共入站端口|**否**|
    |选择要加入的目录|**Microsoft Entra ID**|
    |使用 Intune 注册 VM|**否**|
    |用户名|**学生**|
    |密码|将用作内置 Administrator 帐户密码的任何足够复杂的字符串|
    |确认密码|与之前指定的字符串相同|

    > **备注**：密码长度应至少为 12 个字符，由小写字符、大写字符、数字和特殊字符组合而成。 有关详细信息，请参阅[创建 Azure VM 时的密码要求](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)。

1. 在“**创建主机池**”页的“**工作区**”选项卡中，确认以下设置并选择“**查看 + 创建**”：

    |设置|Value|
    |---|---|
    |注册桌面应用组|**否**|

1. 在“**创建主机池**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > 备注：请等待部署完成。 这可能需要大约 20 分钟。

#### 任务 3：配置 Azure 虚拟桌面应用程序组

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页上，选择“**应用程序组**”。
1. 在“**Azure 虚拟桌面 \| 应用程序组**”页上，注意现有的自动生成的 **az140-21-hp1-DAG** 桌面应用程序组，并选择该组。 
1. 在 **az140-21a-hp1-DAG** 页的垂直导航菜单的“**管理**”部分中，选择“**分配**”。
1. 在“**az140-21-hp1-DAG \| 分配**”页上，选择“**+ 添加**”。
1. 在“**选择 Microsoft Entra 用户或用户组**”页上，选择“**组**”，在搜索框中，键入在本练习的第一个任务中标识的 **AVD-DAG** 组的全名，选中组名旁边的复选框，然后单击“**选择**”。
1. 导航回“**Azure 虚拟桌面 \| 应用程序组**”页，选择“**+ 创建**”。 
1. 在“**创建应用程序组**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 应用程序 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-21e-RG**|
    |主机池|az140-21-hp1|
    |应用程序组类型|**远程应用**|
    |应用程序组名称|az140-21-hp1-Office365-RAG|

1. 在“**创建应用程序组**”页的“**应用程序**”选项卡中，选择“**+ 添加应用程序**”。
1. 在“**添加应用程序**”页上，指定以下设置并选择“**查看 + 添加**”，然后选择“**添加**”：

    |设置|值|
    |---|---|
    |应用程序源|**“开始”菜单**|
    |应用程序|**Word**|
    |显示名称|**Microsoft Word**|
    |说明|**Microsoft Word**|
    |需要命令行|**否**|

1. 返回“**创建应用程序组**”页的“**应用程序**”选项卡上，选择“**+ 添加应用程序**”。
1. 在“**添加应用程序**”页上，指定以下设置并选择“**查看 + 添加**”，然后选择“**添加**”：

    |设置|值|
    |---|---|
    |应用程序源|**“开始”菜单**|
    |应用程序|**Excel**|
    |显示名称|**Microsoft Excel**|
    |说明|**Microsoft Excel**|
    |需要命令行|**否**|

1. 返回“**创建应用程序组**”页的“**应用程序**”选项卡上，选择“**+ 添加应用程序**”。
1. 在“**添加应用程序**”页上，指定以下设置并选择“**查看 + 添加**”，然后选择“**添加**”：

    |设置|值|
    |---|---|
    |应用程序源|**“开始”菜单**|
    |应用程序|**PowerPoint**|
    |显示名称|**Microsoft PowerPoint**|
    |说明|**Microsoft PowerPoint**|
    |需要命令行|**否**|

1. 返回“**创建应用程序组**”页的“**应用程序**”选项卡，选择“**下一步: 分配 >**”。
1. 在“**创建应用程序组**”页的“**分配**”选项卡上，选择“**+ 添加 Microsoft Entra 用户或用户组**”。
1. 在“**选择 Microsoft Entra 用户或用户组**”页上，选择“**组**”，键入在本练习的第一个任务中标识的 **AVD-RemoteApp** 组的全名，选中组名旁边的复选框，然后单击“**选择**”。
1. 返回“**创建应用程序组**”页的“**分配**”选项卡中，选择“**下一步: 工作区 >**”。
1. 在“**创建工作区**”页的“**工作区**”选项卡上，指定以下设置并选择“**查看 + 创建**”：

    |设置|Value|
    |---|---|
    |注册应用程序组|**否**|

1. 在“**创建应用程序组**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > **注意**：等待应用程序组创建完成。 此过程应该会在 1 分钟内完成。 

    > **注意**：接下来，你将基于作为应用程序源的文件路径创建一个应用程序组。

1. 在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页上选择“**应用程序组**”。
1. 在“**Azure 虚拟桌面\|应用程序组**”页面，选择“**+ 创建**” 。 
1. 在“**创建应用程序组**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 应用程序 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-21e-RG**|
    |主机池|az140-21-hp1|
    |应用程序组类型|**RemoteApp**|
    |应用程序组名称|az140-21-hp1-Utilities-RAG|

1. 在“**创建应用程序组**”页的“**应用程序**”选项卡中，选择“**+ 添加应用程序**”。
1. 在“**添加应用程序**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**下一步**”：

    |设置|值|
    |---|---|
    |应用程序源|**文件路径**|
    |应用程序路径|**C:\Windows\system32\cmd.exe**|
    |申请标识符|**命令提示符**|
    |显示名称|**命令提示符**|
    |说明|Windows 命令提示符|
    |需要命令行|**否**|

1. 在“图标”选项卡上，指定以下设置并选择“查看 + 添加”，然后选择“添加”************：

    |设置|“值”|
    |---|---|
    |图标路径|**C:\Windows\system32\cmd.exe**|
    |图标索引|0|

1. 返回“**创建应用程序组**”页的“**应用程序**”选项卡，选择“**下一步: 分配 >**”。
1. 在“**创建应用程序组**”页的“**分配**”选项卡上，选择“**+ 添加 Microsoft Entra 用户或用户组**”。
1. 在“**选择 Microsoft Entra 用户或用户组**”页上，选择“**组**”，键入在本练习的第一个任务中标识的 **AVD-RemoteApp** 组的全名，选中组名旁边的复选框，然后单击“**选择**”。
1. 返回“**创建应用程序组**”页的“**分配**”选项卡中，选择“**下一步: 工作区 >**”。
1. 在“**创建工作区**”页的“**工作区**”选项卡上，指定以下设置并选择“**查看 + 创建**”：

    |设置|Value|
    |---|---|
    |注册应用程序组|**否**|

1. 在“**创建应用程序组**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > **注意**：等待应用程序组创建完成。 此过程应该会在 1 分钟内完成。 

#### 任务 4：创建 Azure 虚拟桌面工作区

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上，选择“**工作区**”。
1. 在“**Azure 虚拟桌面 \| 工作区**”页上，选择“**+ 创建**”。 
1. 在“**创建工作区**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 应用程序组 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-21e-RG**|
    |工作区名称|az140-21-ws1|
    |友好名称|az140-21-ws1|
    |位置|在本实验室的第一个练习中部署了资源的 Azure 区域的名称或与之相近的区域的名称|

1. 在“**创建工作区**”页的“**应用程序组**”选项卡上，指定以下设置 ：

    |设置|值|
    |---|---|
    |注册应用程序组|**是**|

1. 在“**创建工作区**”页的“**工作区**”选项卡中，选择“**+ 注册应用程序组**”。
1. 在“**添加应用程序组**”页上，选择 **az140-21-hp1-DAG**、**az140-21-hp1-Office365-RAG** 和 **az140-21-hp1-Utilities-RAG** 条目旁的加号，然后单击“**选择**”。 
1. 返回到“**创建工作区**”页的“**应用程序组**”选项卡上，选择“**查看 + 创建**”。
1. 在“**创建工作区**”页的“**查看 + 创建**”选项卡上，选择“**创建**”。

#### 任务 5：允许访问 Azure 虚拟桌面主机池

> **备注**：在使用已加入 Microsoft Entra 的会话主机时，需要分配给 Azure 虚拟桌面用户和管理员相应的 Azure 基于角色的访问控制 (RBAC) 角色。 具体而言，需要*虚拟机用户登录*角色才能登录到会话主机，而本地管理权限需要*虚拟机管理员登录*角色。 

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**资源组**”，然后在“**资源组**”页上选择 **az140-21e-RG**。
1. 在 **az140-21e-RG** 页上的垂直导航菜单中，选择“**访问控制(IAM)**”。
1. 在“**az140-21e-RG\|访问控制(IAM)**”页上，选择“**+ 添加**”，然后从下拉菜单中选择“**添加角色分配**”。
1. 在“**添加角色分配**”页的“**角色**”选项卡上，确保已选中“**工作职能角色**”选项卡，在搜索文本框中，输入“**虚拟机用户登录**”，在结果列表中，选择“**虚拟机用户登录**”，然后选择“**下一步**”。
1. 在“**添加角色分配**”页的“**成员**”选项卡上，确保已选中“**用户、组或服务主体**”选项，单击“**+ 选择成员**”，在“**选择成员**”窗格中找到在本练习的第一个任务中标识的 **AVD-RemoteApp** 组，然后单击“**选择**”。
1. 返回到“**添加角色分配**”页的“**成员**”选项卡上，选择“**下一步**”。
1. 在“**添加角色分配**”页的“**分配类型**”选项卡上，将“**分配类型**”设置为“**活动**”，然后选择“**查看+分配**”。
1. 在“**添加角色分配**”页的“**查看 + 分配**”选项卡上，选择“**查看 + 分配**”。 
1. 返回到“**az140-21e-RG\|访问控制(IAM)**”页上，选择“**+ 添加**”，然后从下拉菜单中选择“**添加角色分配**”。
1. 在“**添加角色分配**”页的“**角色**”选项卡上，确保已选中“**工作职能角色**”选项卡，在搜索文本框中，输入“**虚拟机管理员登录**”，在结果列表中选择“**虚拟机管理员登录**”，然后选择“**下一步**”。
1. 在“**添加角色分配**”页的“**成员**”选项卡上，确保已选择“**用户、组或服务主体**”选项，单击“**+选择成员**”，在“**选择成员**”窗格中，找到在本练习的第一个任务中标识的 **AVD-DAG** 组，然后单击“**选择**”。
1. 返回“**添加角色分配**”页的“**成员**”选项卡上，选择“**查看 + 分配**”，然后再次选择“**查看 + 分配**”。 
