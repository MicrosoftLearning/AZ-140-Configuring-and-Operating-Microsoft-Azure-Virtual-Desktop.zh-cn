---
lab:
    title: '实验室：创建和配置主机池和会话主机 (Azure AD DS)'
    module: '模块 2：实现 AVD 基础结构'
---

# 实验室 - 创建和配置主机池和会话主机 (Azure AD DS)
# 学生实验室手册

## 实验室依赖项

- Azure 订阅
- 一个 Microsoft 帐户或 Azure AD 帐户，该帐户具有与 Azure 订阅关联的 Azure AD 租户的全局管理员角色，以及 Azure 订阅的所有者角色或参与者角色
- 已完成实验室 **“准备部署 Azure 虚拟桌面 (Azure AD DS)”**

## 预计用时

60 分钟

## 实验室场景

你需要在 Azure Active Directory 域服务 (Azure AD DS) 环境中创建和配置主机池和会话主机。

## 目标
  
完成本实验室后，你将能够：

- 在 Azure AD DS 域中配置 Azure 虚拟桌面环境。 
- 在 Azure AD DS 域中验证 Azure 虚拟桌面环境。 

## 实验室文件

- 无 

## 说明

### 练习 1：配置 Azure 虚拟桌面环境
  
本练习的主要任务如下：

1. 准备 AD DS 域和 Azure 订阅，以部署 Azure 虚拟桌面主机池
1. 部署 Azure 虚拟桌面主机池
1. 配置 Azure 虚拟桌面应用程序组
1. 配置 Azure 虚拟桌面工作区

#### 任务 1：准备 AD DS 域和 Azure 订阅，以部署 Azure 虚拟桌面主机池

1. 在实验室计算机上，启动 Web 浏览器，导航到 [Azure 门户](https://portal.azure.com)，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。
1. 在实验室计算机上，在 Azure 门户中搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡中，选择 **“az140-cl-vm11a”** 条目。此时会打开 **“az140-cl-vm11a”** 边栏选项卡。
1. 在“**az140-cl-vm11a**”边栏选项卡上，选择“连接”，在下拉菜单中选择“**Bastion**”，在“**az140-cl-vm11a \| 连接**”边栏选项卡的“**Bastion**”选项卡上，选择“**使用 Bastion**”。
1. 出现提示时，请提供以下凭据并选择“**连接**”：

   |设置|值|
   |---|---|
   |用户名|**Student@adatum.com**|
   |密码|**Pa55w.rd1234**|

1. 在与 **az140-cl-vm11a** Azure VM 的远程桌面中，启动 Microsoft Edge，导航到 [Azure 门户](https://portal.azure.com)，然后通过提供 **aadadmin1** 用户帐户的用户主体名称并将创建帐户时设置的密码作为其密码进行登录。

   >**备注**：通过从 Active Directory 用户和计算机控制台查看 aadadmin1 帐户的“属性”对话框，或切换回实验室计算机并从 Azure 门户中的“Azure AD 租户”边栏选项卡查看其属性，可以标识 **aadadmin1** 帐户的用户主体名称 (UPN) 属性。

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 中，在 **Cloud Shell** 中打开 PowerShell 会话并运行以下命令注册 **Microsoft.DesktopVirtualization** 资源提供程序：

   ```powershell
   Register-AzResourceProvider -ProviderNamespace Microsoft.DesktopVirtualization
   ```

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 中，搜索并选择 **“虚拟网络”**，并在 **“虚拟网络”** 边栏选项卡中选择 **“az140-aadds-vnet11a”** 条目。 
1. 在 **“az140-aadds-vnet11a”** 边栏选项卡上，选择 **“子网”**，在 **“子网”** 边栏选项卡上，选择 **“+ 子网”**，在 **“添加子网”** 边栏选项卡上的 **“名称”** 文本框中键入 **“hp1-Subnet”**，将所有其他设置保留为其默认值，然后选择 **“保存”**。 

#### 任务 2：部署 Azure 虚拟桌面主机池

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，搜索并选择 **“Azure 虚拟桌面”**，在 **“Azure 虚拟桌面”** 边栏选项卡左侧垂直菜单的 **“管理”** 部分中，选择 **“主机池”**，然后在 **“Azure 虚拟桌面 \| 主机池”** 边栏选项卡上选择 **“+ 创建”**。 
1. 在 **“创建主机池”** 边栏选项卡的 **“基本信息”** 选项卡中，指定以下设置并选择 **“下一步: 虚拟机 >”**：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**新资源组名称 az140-21a-RG**|
   |主机池名称|**az140-21a-hp1**|
   |位置|本实验室初期向其部署 Azure AD DS 实例的 Azure 区域的名称|
   |验证环境|**否**|
   |主机池类型|**共用**|
   |最大会话限制|**10**|
   |负载均衡算法|**广度优先**|

1. 在 **“创建主机池”** 边栏选项卡的 **“虚拟机”** 选项卡中，指定以下设置（其他设置保留默认值）并选择 **“下一步: 工作区 >”** （将 *<Azure_AD_domain_name>* 占位符替换为与你在其中部署 Azure AD DS 实例的订阅相关的 Azure AD 租户的名称，并将 `<password>` 占位符替换为创建 aadadmin1 帐户时设置的密码）：

   > **备注**：确保你记住了所用的密码。稍后你将在本实验室或后续实验室中用到它。

   |设置|值|
   |---|---|
   |添加虚拟机|**是**|
   |资源组|**默认与主机池相同**|
   |虚拟机位置|在本实验室的第一个练习中，将资源部署到其中的 Azure 区域的名称|
   |可用性选项|**不需要基础结构冗余**|
   |映像类型|**库**|
   |映像|**Windows 10 企业版多会话版本 2004 + Microsoft 365 应用**|
   |虚拟机大小|**标准 D2s v3**|
   |VM 数|**2**|
   |名称前缀|**az140-21-p1**|
   |OS 磁盘类型|**标准 SSD**|
   |虚拟网络|**az140-aadds-vnet11a**|
   |子网|**hp1-Subnet (10.10.1.0/24)**|
   |网络安全组|**基本**|
   |公共入站端口|**否**|
   |指定域或单元|**是**|
   |要加入的域|**adatum.com**|
   |组织单位路径|**OU=AADDC Computers,DC=adatum,DC=com**|
   |AD 域加入 UPN|**aadadmin1@***<Azure_AD_domain_name>*|
   |密码|`<password>`|
   |虚拟机管理员帐户用户名|**student**|
   |虚拟机管理员帐户密码|**Pa55w.rd1234**|

1. 在 **“创建主机池”** 边栏选项卡的 **“工作区”** 选项卡中，指定以下设置并选择 **“查看 + 创建”**：

   |设置|值|
   |---|---|
   |注册桌面应用组|**否**|

1. 在 **“创建主机池”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。

   > **备注**：请等待部署完成。该操作需要约 15 分钟。

#### 任务 3：配置 Azure 虚拟桌面应用程序组

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在 Azure 门户中，搜索并选择 **“Azure 虚拟桌面”**，然后在 **“Azure 虚拟桌面”** 边栏选项卡上，选择 **“应用程序组”**。
1. 在 **“Azure 虚拟桌面 \| 应用程序组”** 边栏选项卡上，选择自动生成的 **az140-21a-hp1-DAG** 桌面应用程序组。
1. 在 **“az140-21a-hp1-DAG”** 边栏选项卡左侧垂直菜单中的 **“管理”** 部分，选择 **“分配”**。
1. 在 **“az140-21a-hp1-DAG \| 分配”** 边栏选项卡上，选择 **“+ 添加”**。
1. 在 **“选择 Azure AD 用户或用户组”** 边栏选项卡上，选择 **“az140-wvd-apooled”**，然后单击 **“选择”**。
1. 导航回到 **“Azure 虚拟桌面 \| 应用程序组”** 边栏选项卡，然后再次选择 **“+ 创建”**。
1. 在 **“创建应用程序组”** 边栏选项卡的 **“基本信息”** 选项卡中，指定以下设置并选择 **“下一步: 应用程序 >”**：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**az140-21a-RG**|
   |主机池|**az140-21a-hp1**|
   |应用程序组类型|**RemoteApp**|
   |应用程序组名称|**az140-21a-hp1-Office365-RAG**|

1. 在 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“+ 添加应用程序”**。
1. 在 **“添加应用程序”** 边栏选项卡上，指定以下设置并选择 **“保存”**：

   |设置|值|
   |---|---|
   |应用程序源|**“开始”菜单**|
   |应用程序|**Word**|
   |说明|**Microsoft Word**|
   |需要命令行|**否**|

1. 返回 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“+ 添加应用程序”**。
1. 在 **“添加应用程序”** 边栏选项卡上，指定以下设置并选择 **“保存”**：

   |设置|值|
   |---|---|
   |应用程序源| **“开始”** 菜单|
   |应用程序|**Excel**|
   |说明|**Microsoft Excel**|
   |需要命令行|**否**|

1. 返回 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“+ 添加应用程序”**。
1. 在 **“添加应用程序”** 边栏选项卡上，指定以下设置并选择 **“保存”**：

   |设置|值|
   |---|---|
   |应用程序源| **“开始”** 菜单|
   |应用程序|**PowerPoint**|
   |说明|**Microsoft PowerPoint**|
   |需要命令行|**否**|

1. 返回 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“下一步: 分配 >”**。
1. 在 **“创建应用程序组”** 边栏选项卡的 **“分配”** 选项卡中，选择 **“+ 添加 Azure AD 用户或用户组”**。
1. 在 **“选择 Azure AD 用户或用户组”** 边栏选项卡上，选择 **“az140-wvd-aremote-app”** 并单击 **“选择”**。
1. 返回 **“创建应用程序组”** 边栏选项卡的 **“分配”** 选项卡，选择 **“下一步: 工作区 >”**。
1. 在 **“创建工作区”** 边栏选项卡的 **“工作区”** 选项卡中，指定以下设置并选择 **“查看 + 创建”**：

   |设置|值|
   |---|---|
   |注册应用程序组|**否**|

1. 在 **“创建应用程序组”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。

   > **备注**： 现在你将根据作为应用程序源的文件路径创建一个应用程序组

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择 **“Azure 虚拟桌面”**，在 **“Azure 虚拟桌面”** 边栏选项卡上，选择 **“应用程序组”**。
1. 在 **“Azure 虚拟桌面 \| 应用程序组”** 边栏选项卡上，选择 **“+ 创建”**。 
1. 在 **“创建应用程序组”** 边栏选项卡的 **“基本信息”** 选项卡中，指定以下设置并选择 **“下一步: 应用程序 >”**：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**az140-21a-RG**|
   |主机池|**az140-21a-hp1**|
   |应用程序组类型|**RemoteApp**|
   |应用程序组名称|**az140-21a-hp1-Utilities-RAG**|

1. 在 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“+ 添加应用程序”**。
1. 在 **“添加应用程序”** 边栏选项卡上，指定以下设置并选择 **“保存”**：

   |设置|值|
   |---|---|
   |应用程序源|**文件路径**|
   |应用程序路径|**C:\Windows\system32\cmd.exe**|
   |应用程序名称|**命令提示符**|
   |显示名称|**命令提示符**|
   |图标路径|**C:\Windows\system32\cmd.exe**|
   |图标索引|**0**|
   |说明|**Windows 命令提示符**|
   |需要命令行|**否**|

1. 返回 **“创建应用程序组”** 边栏选项卡的 **“应用程序”** 选项卡中，选择 **“下一步: 分配 >”**。
1. 在 **“创建应用程序组”** 边栏选项卡的 **“分配”** 选项卡中，选择 **“+ 添加 Azure AD 用户或用户组”**。
1. 在 **“选择 Azure AD 用户或用户组”** 边栏选项卡上，选择 **“az140-wvd-aremote-app”** 和 **“az140-wvd-aadmins”**，然后单击 **“选择”**。
1. 返回 **“创建应用程序组”** 边栏选项卡的 **“分配”** 选项卡，选择 **“下一步: 工作区 >”**。
1. 在 **“创建工作区”** 边栏选项卡的 **“工作区”** 选项卡中，指定以下设置并选择 **“查看 + 创建”**：

   |设置|值|
   |---|---|
   |注册应用程序组|**否**|

1. 在 **“创建应用程序组”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。

#### 任务 4：配置 Azure 虚拟桌面工作区

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，搜索并选择 **“Azure 虚拟桌面”**，在 **“Azure 虚拟桌面”** 边栏选项卡上，选择 **“工作区”**。
1. 在 **“Azure 虚拟桌面 \| 工作区”** 边栏选项卡中，选择 **“+ 创建”**。 
1. 在 **“创建工作区”** 边栏选项卡的 **“基本信息”** 选项卡上，指定以下设置并选择 **“下一步: 应用程序组 >”**：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**az140-21a-RG**|
   |工作区名称|**az140-21a-ws1**|
   |易记名称|**az140-21a-ws1**|
   |位置|在本实验室中向其部署资源的 Azure 区域的名称||

1. 在 **“创建工作区”** 边栏选项卡的 **“应用程序组”** 选项卡上，指定以下设置：

   |设置|值|
   |---|---|
   |注册应用程序组|**是**|

1. 在 **“创建工作区”** 边栏选项卡的 **“工作区”** 选项卡中，选择 **“+ 注册应用程序组”**。
1. 在 **“添加应用程序组”** 边栏选项卡上，选择 **“az140-21a-hp1-DAG”**、 **“az140-21a-hp1-Office365-RAG”** 和 **“az140-21a-hp1-Utilities-RAG”** 条目旁边的加号，然后单击 **“选择”**。 
1. 返回到 **“创建工作区”** 边栏选项卡的 **“应用程序组”** 选项卡，选择 **“查看 + 创建”**。
1. 在 **“创建工作区”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。

### 练习 2：验证 Azure 虚拟桌面环境
  
本练习的主要任务如下：

1. 在 Windows 10 计算机上安装 Microsoft 远程桌面客户端 (MSRDC)
1. 订阅 Azure 虚拟桌面工作区
1. 测试 Azure 虚拟桌面应用

#### 任务 1：在 Windows 10 计算机上安装 Microsoft 远程桌面客户端 (MSRDC)

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，启动 Microsoft Edge 并导航到 [Windows 桌面客户端下载页](https://go.microsoft.com/fwlink/?linkid=2068602)，并在出现提示时，按照提示运行其安装。选择 **“为此计算机上的所有用户安装”** 选项。 
1. 安装完成后，启动远程桌面客户端。

#### 任务 2：订阅 Azure 虚拟桌面工作区

1. 在 **“远程桌面”** 客户端窗口中，选择 **“订阅”**，并在出现提示时使用 **aaduser1** 凭据登录（使用其 userPrincipalName 属性作为用户名，并使用你创建该帐户时设置的密码）。 

   > **备注**： 或者，在 **“远程桌面”** 客户端窗口中，选择 **“通过 URL 订阅”**，在 **“订阅工作区”** 窗格中的 **“电子邮件或工作区 URL”** 中，键入 **“https://rdweb.wvd.microsoft.com/api/arm/feeddiscovery”** ，选择 **“下一步”**，并在出现提示后，使用 **aaduser1** 凭据登录（使用其 userPrincipalName 属性作为用户名，使用 **Pa55w.rd1234** 作为其密码）。 

   > **备注**： **aaduser1** 的用户主体名称应采用 **aaduser1@***<Azure_AD_domain_name>* 格式，其中 *<Azure_AD_domain_name>* 占位符与在其中部署 Azure AD DS 实例的订阅关联的 Azure AD 租户的名称相匹配。

1. 在 **“保持登录到所有应用”** 窗口中，清除复选框 **“允许组织管理我的设备”**，然后选择 **“否，仅登录到此应用”**。 
1. 确保 **“远程桌面”** 页显示通过用户帐户 **aaduser1** 的组成员身份与之关联的应用程序组中包含的应用程序列表。 

#### 任务 3：测试 Azure 虚拟桌面应用

1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在 **“远程桌面”** 客户端窗口的应用程序列表中，双击 **“命令提示符”**，并验证它是否启动了 **“命令提示符”** 窗口。提示进行身份验证时，输入你为 **aaduser1** 用户帐户设置的密码，选中“**记住我**”复选框，然后选择“**确定**”。

   > **备注**： 最开始应用程序可能需要几分钟才能启动，但之后启动速度应该会快得多。

1. 在命令提示符下，键入**主机名**并按 **Enter** 键以显示运行命令提示符的计算机的名称。

   > **备注**： 验证显示的名称是 **az140-21-p1-0** 或 **az140-21-p1-1**，而不是 **az140-cl-vm11a**。

1. 在命令提示符下，键入 **“logoff”** 并按 **Enter** 键以从当前远程应用会话中注销。
1. 在与 **az140-cl-vm11a** 的远程桌面会话中，在 **“远程桌面”** 客户端窗口的应用程序列表中，双击 **“SessionDesktop”**，并验证它是否启动了远程桌面会话。 
1. 在**默认桌面**会话中，右键单击 **“开始”**，选择 **“运行”**，在 **“运行”** 对话框的 **“打开”** 文本框中，键入 **“cmd”** 并选择 **“确定”**。 
1. 在**默认桌面**会话中，在命令提示符下键入主**机名**并按 **Enter** 键以显示运行远程桌面会话的计算机的名称。
1. 验证显示的名称是否为 **az140-21-p1-0**、 **az140-21-p1-1** 或 **az140-21-p1-2**。
