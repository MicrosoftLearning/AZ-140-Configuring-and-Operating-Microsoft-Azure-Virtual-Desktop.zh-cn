---
lab:
  title: 实验室：实现和管理 AVD 的存储 (Microsoft Entra DS)
  module: 'Module 2: Implement an AVD Infrastructure'
---

# 实验室 - 实现和管理 AVD 的存储 (Microsoft Entra DS)
# 学生实验室手册

## 实验室依赖项

- Azure 订阅
- Microsoft 帐户或 Microsoft Entra 帐户，在与 Azure 订阅关联的 Microsoft Entra 租户中具有全局管理员角色并在 Azure 订阅中具有所有者或参与者角色
- 已完成实验室“准备部署 Azure 虚拟桌面 (Microsoft Entra DS)”****

## 预计用时

30 分钟

## 实验室方案

需要在 Microsoft Entra DS 环境中实现和管理用于 Azure 虚拟桌面部署的存储。

## 目标
  
完成本实验室后，你将能够：

- 配置 Azure 文件存储以在 Microsoft Entra DS 环境中存储 Azure 虚拟桌面的配置文件容器

## 实验室文件

- 无

## 说明

### 练习 1：配置 Azure 文件存储以存储 Azure 虚拟桌面的配置文件容器

此练习的主要任务如下：

1. 创建 Azure 存储帐户
1. 创建 Azure 文件存储共享
1. 为 Azure 存储帐户启用 Microsoft Entra DS 身份验证 
1. 配置 Azure 文件存储共享权限
1. 配置 Azure 文件存储目录级别或文件级别的权限

#### 任务 1：创建 Azure 存储帐户

1. 在实验室计算机上，启动 Web 浏览器，导航到 [Azure 门户](https://portal.azure.com)，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。
1. 在实验室计算机上的 Azure 门户中，搜索并选择“虚拟机”****，然后在“虚拟机”**** 边栏选项卡中，选择“az140-cl-vm11a”**** 条目。 这将打开“az140-cl-vm11a”**** 边栏选项卡。
1. 在“az140-cl-vm11a”边栏选项卡中，选择“连接”，在下拉菜单中选择“Bastion”，在“az140-cl-vm11a \| 连接”边栏选项卡的“Bastion”选项卡中，选择“使用 Bastion”************************。
1. 出现提示时，提供以下凭据并选择“连接”：

   |设置|值|
   |---|---|
   |用户名|**aadadmin1@adatum.com**|
   |密码|之前定义的密码|

1. 在与 az140-cl-vm11a**** Azure VM 的 Bastion 会话中，启动 Microsoft Edge，导航到 [Azure 门户](https://portal.azure.com)，然后通过提供 aadadmin1**** 用户帐户的用户主体名称和创建此帐户时设置的密码进行登录。

   >**备注**：可以通过从“Active Directory 用户和计算机”控制台中查看其属性对话框，或者从 Azure 门户的 Microsoft Entra 租户边栏选项卡中切换回实验室计算机并查看其属性，来确定 aadadmin1**** 帐户的用户主体名称 (UPN) 属性。

1. 在与 az140-cl-vm11a**** 的 Bastion 会话中，在显示 Azure 门户的 Microsoft Edge 窗口中搜索并选择“存储帐户”****，并在“存储帐户”**** 边栏选项卡上选择“+ 创建”****。
1. 在“创建存储帐户”边栏选项卡的“基本信息”选项卡上，指定以下设置（其他设置保留默认值） ：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|新资源组名称 az140-22a-RG****|
   |存储帐户名称|长度在 3 到 15 之间的任何全局唯一名称，由小写字母和数字组成，以字母开头|
   |位置|托管 Azure 虚拟桌面实验室环境的 Azure 区域的名称|
   |性能|**标准**|
   |复制|**本地冗余存储 (LRS)**|

   >**备注**：确保存储帐户名称的长度不超过 15 个字符。 该名称将用于在 Active Directory 域服务 (AD DS) 域中创建一个计算机帐户，该帐户与包含存储帐户的 Azure 订阅关联的 Microsoft Entra 租户集成。 访问此存储帐户中托管的文件共享时，这将允许进行基于 AD DS 的身份验证。

1. 在“创建存储帐户”边栏选项卡的“基本信息”选项卡上，选择“查看 + 创建”，等待验证过程完成，然后选择“创建”。

   >**注意**：请等待存储帐户创建完成。 这应该需要大约两分钟。

#### 任务 2：创建 Azure 文件存储共享

1. 在与 az140-cl-vm11a**** 的 Bastion 会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，导航回“存储帐户”**** 边栏选项卡，然后选择表示新创建的存储帐户的条目。
1. 在存储帐户边栏选项卡的左侧垂直菜单中，在“数据存储”**** 部分，选择“文件共享”****，然后选择“+ 文件共享”****。
1. 在“新建文件共享”**** 边栏选项卡上，指定以下设置，然后选择“创建”****（其他设置保留默认值）：

   |设置|值|
   |---|---|
   |名称|az140-22a-profiles****|

#### 任务 3：为 Azure 存储帐户启用 Microsoft Entra DS 身份验证

1. 依次在与 az140-cl-vm11a**** 的 Bastion 会话中、Microsoft Edge 窗口中、Azure 门户中、显示上一个任务中创建的存储帐户属性的边栏选项卡上、左侧垂直菜单中、“数据存储”**** 部分中，选择“文件共享”****。 
1. 在“文件共享设置”部分的“Active Directory”标签旁边，选择“未配置”链接************。
1. 在“启用 Active Directory 源”部分中，在标有“Azure Active Directory 域服务”的矩形中，选择“设置”************。
1.  在“基于标识的访问”**** 边栏选项卡上，选择“已启用”**** 选项，然后选择“保存”****。

#### 任务 4：配置基于 RBAC 的 Azure 文件存储权限

1. 依次在与 az140-cl-vm11a**** 的 Bastion 会话中、显示 Azure 门户的 Microsoft Edge 窗口中、显示之前在此练习中创建的存储帐户属性的边栏选项卡上、左侧垂直菜单中、“数据存储”**** 部分中，选择“文件共享”****，然后在共享列表中选择“az140-22a-profiles”**** 条目。
1. 在“az140-22a-profiles”**** 边栏选项卡的左侧垂直菜单中，选择“访问控制(IAM)”****。
1. 在“az140-22a-profiles \| 访问控制(IAM)”边栏选项卡上，选择“+ 添加”，然后从下拉菜单中选择“添加角色分配”************。
1. 在“添加角色分配”边栏选项卡上，选择“存储文件数据 SMB 共享参与者”，然后选择“下一步”************：
1. 在“成员”边栏选项卡上，选择“将访问权限分配给”，然后单击“+ 选择成员”************。
1. 在“选择成员”边栏选项卡上的“选择”文本框中，键入“az140-wvd-ausers”，然后单击“选择”****************。
1. 在“成员”边栏选项卡上，选择两次“查看 + 分配”********。
1. 重复上述步骤 3-8，指定以下设置：

   |设置|值|
   |---|---|
   |角色|**存储文件数据 SMB 共享提升参与者**|
   |选择|az140-wvd-aadmins****|

   > **备注**：将使用 aadadmin1**** 用户帐户（az140-wvd-aadmins**** 组的成员）来配置文件共享权限。 

#### 任务 5：配置 Azure 文件存储目录级别或文件级别的权限

1. 在与 az140-cl-vm11a**** 的 Bastion 会话中，启动“命令提示符”****，然后从“命令提示符”**** 窗口运行以下命令，将驱动器映射到目标共享（将 `<storage-account-name>` 占位符替换为存储帐户的名称）：

   ```cmd
   net use Z: \\<storage-account-name>.file.core.windows.net\az140-22a-profiles
   ```

1. 在与 az140-cl-vm11a**** 的 Bastion 会话中，打开文件资源管理器，导航到新映射的 Z: 驱动器，显示其“属性”**** 对话框，选择“安全”**** 选项卡，选择“编辑”****，选择“添加”****，在“选择用户”、“计算机”、“服务帐户”和“组”**** 对话框中，确保“从此位置”**** 文本框中包含“adatum.com”**** 条目，在“输入要选择的对象名称”**** 文本框中，键入“az140-wvd-ausers”****，然后单击“确定”****。
1. 返回显示映射驱动器权限的对话框的“安全”**** 选项卡，确保选中“az140-wvd-ausers”**** 条目，选择“允许”**** 列中的“修改”**** 复选框，单击“确定”****，查看“Windows 安全”**** 文本框中显示的消息，然后单击“是”****。 
1. 返回显示映射驱动器权限的对话框的“安全”**** 选项卡，选择“编辑”****，选择“添加”****，在“选择用户”、“计算机”、“服务帐户”和“组”**** 对话框中，确保“从此位置”**** 文本框中包含“adatum.com”**** 条目，在“输入要选择的对象名称”**** 文本框中，键入“az140-wvd-aadmins”****，然后单击“确定”****。
1. 返回显示映射驱动器权限的对话框的“安全”**** 选项卡，确保选中“az140-wvd-aadmins”**** 条目，选择“允许”**** 列中的“完全控制”**** 复选框，然后单击“确定”****。 
1. 在显示映射驱动器权限的对话框的“安全”**** 选项卡上，选择“编辑”****，在组和用户名列表中，选择“经过身份验证的用户”**** 条目，然后选择“移除”****。
1. 仍在“编辑”屏幕上时，在组和用户名列表中，选择“用户”条目，选择“删除”，单击“确定”，然后单击“确定”两次以完成该过程****************。 

   >**备注**：或者，可以使用 icacls**** 命令行实用工具设置权限。 
