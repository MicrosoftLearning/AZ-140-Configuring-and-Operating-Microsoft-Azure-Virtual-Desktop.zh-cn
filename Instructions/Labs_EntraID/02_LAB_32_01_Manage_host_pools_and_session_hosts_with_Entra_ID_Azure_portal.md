---
lab:
  title: 实验室：使用 Azure 门户管理主机池和会话主机 (Entra ID)
  module: 'Module 3.2: Plan and implement user experience and client settings'
---

# 实验室 - 使用 Azure 门户管理主机池和会话主机 (Entra ID)
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft Entra 用户帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者或参与者角色，在与该 Azure 订阅关联的 Entra 租户中具有足够加入设备的权限。
- 已完成实验室*使用 Azure 门户部署主机池和会话主机 (Entra ID)*

## 预计用时

30 分钟

## 实验室方案

你有一个现成的 Azure 虚拟桌面环境。 需要配置 Microsoft Entra 已加入会话主机的主机池，才能支持一系列功能和业务要求。 这些要求包括:

- 部署其他会话主机以容纳数量增加的远程用户
- 通过优化主机池负载均衡配置并利用*连接时启动 VM* 功能，最大程度地降低 Azure 虚拟桌面环境的成本
- 通过实现维护时段，在工作时间最大程度提高会话主机的可用性
- 启用已加入 Microsoft Entra 的会话主机的单一登录
- 最大程度提升可用性和用户体验（例如自动重新连接断开连接的会话）

## 目标
  
完成本实验室后，你将能够：

- 配置已加入 Microsoft Entra 的 Azure 虚拟桌面会话主机，以支持一系列功能和业务要求

## 实验室文件

- 无

## 说明

### 练习 1：管理包含已加入 Microsoft Entra 的会话主机的 Azure 虚拟桌面环境
  
此练习的主要任务如下：

1. 部署其他 Azure 虚拟桌面主机池会话主机
1. 查看和配置主机池属性
1. 向 Azure 虚拟桌面服务主体分配所需的 RBAC 角色
1. 配置计划的代理更新
1. 配置主机池的 RDP 属性

#### 任务 1：部署其他 Azure 虚拟桌面主机池会话主机

1. 如果需要，在实验室计算机上，启动 Web 浏览器，导航到 Azure 门户，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。

    > **备注**：使用实验室会话窗口右侧“资源”选项卡上列出的 `User1-` 帐户的凭据。

1. 在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后，在“**Azure 虚拟桌面**”页上，在垂直菜单栏的“**管理**”部分中，选择“**主机池**”。
1. 在“**Azure 虚拟桌面 \| 主机池**”页的主机池列表中，选择“**az140-21-hp1**”。
1. 在“**az140-21-hp1**”页上，在垂直菜单栏的“**管理**”部分中，选择“**会话主机**”，然后验证池是否由两个主机组成。 
1. 在“**az140-21-hp1 \| 会话主机**”页中，选择“**+ 添加**”。
1. 在“**将虚拟机添加到主机池**”页的“**基本信息**”选项卡中，查看预配置的设置并选择“**下一步: 虚拟机**”。
1. 在“**将虚拟机添加到主机池**”页的“**虚拟机**”选项卡中，指定以下设置并选择“**查看 + 创建**”（其他设置保留默认值）：

    > **备注**：设置“**名称前缀**”值时，切换到实验室会话窗口右侧的“资源”选项卡，并标识 *User1-* 和 *@* 字符之间的字符串。 使用此字符串替换 *random* 占位符。

    |设置|值|
    |---|---|
    |资源组|**az140-21e-RG**|
    |名称前缀|**sh**-*random*|
    |虚拟机位置|将前两个会话主机 VM 部署到其中的 Azure 区域的名称|
    |可用性选项|**没有所需的基础结构冗余**|
    |安全类型|**受信任启动虚拟机**|
    |映像|**Windows 11 企业版多会话版本 23H2 + Microsoft 365 应用版**|
    |虚拟机大小|**标准 DC2s_v3**|
    |VM 数量|**1**|
    |OS 磁盘类型|**标准 SSD**|
    |OS 磁盘大小|**默认大小 (128GB)**|
    |启动诊断|使用托管存储帐户启用（推荐）|
    |虚拟网络|**az140-vnet11e**|
    |子网|hp1-Subnet|
    |网络安全组|**基本**|
    |公共入站端口|**否**|
    |选择要加入的目录|**Microsoft Entra ID**|
    |使用 Intune 注册 VM|**否**|
    |用户名|**学生**|
    |密码|在实验室中部署会话主机时使用的同一个密码 *使用 Azure 门户 (Entra ID) 部署主机池和会话主机* 
    |确认密码|前面指定的同一个密码|

    > **备注**：密码长度应至少为 12 个字符，由小写字符、大写字符、数字和特殊字符组合而成。 有关详细信息，请参阅[创建 Azure VM 时的密码要求](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)。

    > **注意**：正如你可能注意到的，在将会话主机添加到现有池时，可以更改 VM 的映像和前缀。 通常，除非计划替换池中的所有 VM，否则不建议这样做。 

1. 在“**将虚拟机添加到主机池**”页的“**查看 + 创建**”选项卡中，选择“**创建**”

    > **注意**：请勿等待预配过程完成，而是继续执行下一个任务。 预配过程可能需要 20 分钟。 

#### 任务 2：查看和配置主机池属性

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器中搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单的“**管理**”部分中，选择“**主机池**”，在“**Azure 虚拟桌面 \| 主机池**”页上，选择 **az140-21-hp1**。 
1. 在**az140-21-hp1**页的“**设置**”部分，选择“**属性**”。
1. 在“**az140-21-hp1\|属性**”页上，查看可用的配置选项，包括：

    - **首选应用组类型**：此选项将主机池的首选应用组类型设置为“**桌面**”或“**RemoteApp**”。 如果最终用户在主机池中同时发布了 RemoteApp 和桌面应用，他们只会在其源中看到所选的应用类型。
    - **连接时启动 VM**：启用此选项允许用户从解除分配状态启动主机池中的单个虚拟机。
    - **验证环境**：验证主机池适用于在将服务更改部署到生产之前测试服务更改。
    - **负载均衡算法**：此选项提供广度优先和深度优先负载均衡之间的选择。 广度优先负载均衡可在主机池中所有可用会话主机之间分配新的用户会话。 深度优先负载均衡可将新的用户会话分发到可用会话主机，这些会话主机具有最大连接数但未达到最大会话限制阈值。

1. 在“**az140-21-hp1\|属性**”页上的“**负载均衡算法**”下拉列表中，选择“**深度优先**”。
1. 在“**最大会话限制**”文本框中，输入“**8**”。
1. 在“**az140-21-hp1\|属性**”页上，将“**连接时启动 VM**”设置为“**是**”。

    > **备注**：借助*连接时启动 VM*，你可以让最终用户仅在需要将虚拟机 (VM) 用作会话主机时才将其打开，从而降低成本。 对于个人主机池，“连接时启动 VM”** 将仅在已分配给或可以分配给用户的现有会话主机 VM 上启动。 对于共用主机池，“连接时启动 VM”** 将仅在未启动会话主机 VM 时启动，并且仅在第一个 VM 达到会话限制时启动更多 VM。

1. 在“**az140-21-hp1\|属性**”页上，选择“**保存**”。

    > **备注**：要使用“*连接时启动 VM*”，需要先在 Azure 订阅范围内向 *Azure 虚拟桌面*服务主体分配*桌面虚拟化启用参与者*这一基于角色的访问控制 (RBAC) 角色。 

#### 任务 3：将所需的 RBAC 角色分配给 Azure 虚拟桌面服务主体

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器中，开启 Azure Cloud Shell 中的 PowerShell 会话。

    > **备注**：如果出现提示，请在“**入门**”窗格中的“**订阅**”下拉列表中，选择正在本实验室中使用的 Azure 订阅的名称，然后选择“**应用**”。

1. 在“Azure Cloud Shell”窗格中的 PowerShell 会话中，运行以下命令以检索正在此实验室中使用的 Azure 订阅的 ID 属性的值，并将其存储在变量 `$subId` 中：

    ```powershell
    $subId = (Get-AzSubscription).Id
    ```

1. 运行以下命令以创建一个 $parameters 变量，该变量用于存储包含 RBAC 角色定义名称值的哈希表，表示 **Azure 虚拟桌面**服务主体的 Microsoft Entra 应用程序以及订阅范围：

    ```powershell
    $parameters = @{
        RoleDefinitionName = "Desktop Virtualization Power On Contributor"
        ApplicationId = "9cdead84-a844-4324-93f2-b2e6bb768d07"
        Scope = "/subscriptions/$subId"
    }
    ```

1. 运行以下命令以创建 RBAC 角色分配：

    ```powershell
    New-AzRoleAssignment @parameters
    ```

1. 关闭 Cloud Shell 窗格。

#### 任务 4：配置计划的代理更新

> **备注**：借助计划的代理更新功能，可创建最多两个维护时段来更新 Azure 虚拟桌面代理、并行堆栈和 Geneva 监视代理，从而避免在工作时间进行这些更新。 

1. 在显示 Azure 门户的 Web 浏览器中，重新导航到 **az140-21-hp1** 主机池页面。
1. 在 **az140-21-hp1** 页上，在垂直菜单栏的“**设置**”部分中，选择“**计划的代理更新**”条目，然后在“**az140-21-hp1\|计划的代理更新**”页上，选中“**计划的代理更新**”复选框。
1. 在“**计划**”部分中，选中“**使用本地会话主机时区**”复选框。
1. 在“**维护时段**”部分的“**日期**”下拉列表中，选择“**星期六**”，然后在“**时间**”下拉列表中选择“**晚上 11:00**”。
1. 选择“应用”。

#### 任务 5：配置主机池的 RDP 属性

1. 在显示 Azure 门户的 Web 浏览器中，在 **az140-21-hp1** 页上的垂直菜单栏中的“**设置**”部分，选择“**RDP 属性**”条目。
1. 在“**az140-21-hp1\|RDP 属性**”页的“**连接信息**”选项卡上，查看可用的配置选项，包括：

    - **Microsoft Entra 单一登录**：此选项用于确定连接是否会尝试利用 Microsoft Entra 身份验证登录到已加入 Microsoft Entra 的会话主机，并有效地提供单一登录体验。 请注意，客户端计算机不需要加入 Microsoft Entra。 
    - **凭据安全支持提供程序**：此选项控制是否使用 CredSSP 进行身份验证。 CredSSP 支持将用户凭据从客户端设备安全转发到远程桌面会话主机。 但是，其功能不包括对 Entra ID 身份验证的支持。
    - **备用 shell**：借助此选项，你可以指定在任何时候建立与会话主机的新连接时启动的可执行文件。 此设置仅适用于运行 Windows Server 的会话主机。
    - **KDC 代理名称**：此选项提供将 Kerberos 身份验证流量代理到 Active Directory 域控制器的功能。

    > **备注**：考虑到这三个选项不适用于我们的应用场景（该应用场景涉及未出现任何 Active Directory 域服务且已加入 Microsft Entra 的会话主机），你将仅配置第一个。 此选项对应于 `enablerdsaadauth:i:value` RDP 属性。

1. 在“**Microsoft Entra 单一登录**”下拉列表中，选择“**连接将使用 Microsoft Entra 身份验证提供单一登录**”选项，然后选择“**保存**”。

    > **重要提示**：请务必记住，启用此特定的 RDP 属性只是实现单一登录功能所需的几个步骤之一。 适用于此应用场景的其他操作包括为 Entra 租户中的 RDP 启用 Microsoft Entra 身份验证，以及配置设备组，这些组在当前版本的实验室环境中不受支持，因此未包含在说明中。 有关实现 Microsoft Entra ID 的单一登录所需操作的完整列表，请参阅[使用 Microsoft Entra ID 身份验证为 Azure 虚拟桌面配置单一登录](https://learn.microsoft.com/en-us/azure/virtual-desktop/configure-single-sign-on)。

1. 在“**az140-21-hp1\|RDP 属性**”页上，选择“**会话行为**”选项卡并查看可用的配置选项，包括：

    - **重新连接**：此选项用于确定客户端计算机是否会在连接断开时自动尝试重新连接到远程计算机。
    - **带宽自动检测**：此选项用于确定是否使用自动网络带宽检测。
    - **网络自动检测**：借助此选项，你可以启用网络类型的自动检测。 它与**带宽自动检测**结合使用。 
    - **压缩**：此选项用于确定连接是否应使用批量压缩。
    - **视频播放**：此选项支持你使用 RDP 高效多媒体流式处理进行视频播放。

1. 在“**会话行为**”选项卡上的“**重新连接**”下拉列表中，选择“**客户端自动尝试重新连接**”，然后选择“**保存**”。
1. 在“**az140-21-hp1\|RDP 属性**”页上，选择“**设备重定向**”选项卡并查看可用的配置选项，其中包括两个主要类别：

    - **音频和视频**
    - **本地设备和资源**

    > **备注**：默认情况下，重定向适用于所有磁盘驱动器，包括建立初始连接后装载的磁盘驱动器。

1. 在“**az140-21-hp1\|RDP 属性**”页上，选择“**显示设置**”选项卡并查看可用的配置选项，包括对多个显示器、智能调整大小和特定桌面大小（以像素为单位）的支持。 
1. 在“**az140-21-hp1\|RDP 属性**”页上，选择“**高级**”选项卡并查看现有的配置设置。 请注意，这些设置反映了之前在此任务中所做的更改。