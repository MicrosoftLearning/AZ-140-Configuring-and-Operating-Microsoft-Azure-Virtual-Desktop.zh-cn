---
lab:
  title: 实验室：实现用于 Azure 虚拟桌面的 Azure 专用链接
  module: 'Module 1.1: Plan, implement, and manage networking for Azure Virtual Desktop'
---

# 实验室 - 实现用于 Azure 虚拟桌面的 Azure 专用链接
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft Entra 帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者角色，并且具有将设备加入与该 Azure 订阅关联的 Entra 租户的足够权限。
- 已完成实验室*使用 Azure 门户部署主机池和会话主机 (Entra ID)*

## 预计用时

60 分钟

## 实验室方案

你有一个现成的 Azure 虚拟桌面环境。 需要使用 Azure 专用链接实现与环境的连接。 

## 目标
  
完成本实验室后，你将能够：

- 实现用于 Azure 虚拟桌面的 Azure 专用链接

## 实验室文件

- 无

## 说明

### 练习 1：实现用于 Azure 虚拟桌面的 Azure 专用链接
  
此练习的主要任务如下：

1. 重新注册 Azure 虚拟桌面资源提供程序
1. 创建 Azure 虚拟网络子网
1. 实现专用终结点以连接到主机池
1. 实现用于源下载的专用终结点
1. 实现用于初始源发现的专用终结点
1. 验证专用终结点功能
1. 允许公用网络访问主机池和工作区

> **备注**：Azure 虚拟桌面有三个工作流，其中包含可与专用终结点配合使用的三种相应的资源类型。 这些工作流是：

- **初始源发现**：允许 RDP 客户端发现分配给用户的所有工作区。 若要通过专用链接实现此工作流，需要在属于 Azure 虚拟桌面部署的任何工作区中创建全局子资源的单个专用终结点。 但是，无论选择哪个工作区，每个部署只能有一个专用终结点提供此功能
- **源下载**：允许 RDP 客户端下载托管当前用户应用程序组的所有工作区的连接详细信息。 若要通过专用链接实现此工作流，需要为要通过专用终结点提供的每个工作区的源子资源创建专用终结点。
- **与主机池的连接**：允许 RDP 客户端和会话主机连接到主机池。 若要通过专用链接实现此工作流，需要为要通过专用终结点提供的每个主机池的连接子资源创建专用终结点。

> **备注**：可以按以下排列实现这些工作流：

- 连接的所有部分（初始源发现、源下载以及客户端和会话主机的远程会话连接）都使用专用路由。
- 客户端和会话主机的源下载和远程会话连接使用专用路由，但初始源发现使用公共路由。 
- 仅客户端和会话主机的远程会话连接使用专用路由，而初始源发现和源下载使用公共路由。
- 客户端和会话主机 VM 都使用公共路由。 此方案中不使用专用链接。

> **备注**：在此实验室中，你将实现第一个排列。

#### 任务 1：重新注册 Azure 虚拟桌面资源提供程序

> **备注**：在将专用链接与 Azure 虚拟桌面配合使用之前，需要重新注册 **Microsoft.DesktopVirtualization** 资源提供程序。 

1. 如果需要，在实验室计算机上，启动 Web 浏览器，导航到 Azure 门户，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。

    > **备注**：使用实验室会话窗口右侧“资源”选项卡上列出的 `User1-` 帐户的凭据。

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**订阅**”，在“**订阅**”页上，选择正在本实验室中使用的 Azure 订阅，然后在“**设置**”部分的垂直导航菜单中，选择“**资源提供程序**”。
1. 在“**资源提供程序**”选项卡上的搜索文本框中，输入 **Microsoft.DesktopVirtualization**，在结果列表中，选择 **Microsoft.DesktopVirtualization** 条目左侧的小圆圈，然后选择“**重新注册**”。

    > **备注**：等待重新注册过程完成。 这通常需要不到 1 分钟。

#### 任务 2：创建 Azure 虚拟网络子网

> **备注**：可以使用 Azure 虚拟网络的现有子网在实验室方案中实现专用终结点，但出于此目的，常见做法是使用专用子网。

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**虚拟网络**”，然后在“**虚拟网络**”页上，选择 **az140-vnet11e**。
1. 在 **az140-vnet11e** 页上，在垂直导航菜单的“**设置**”部分中，选择“**子网**”。
1. 在“**az140-vnet11e \| 子网**”页中，选择“**+ 子网**”。
1. 在“**添加子网**”窗格中，指定以下设置并选择“**添加**”（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |名称|**pe-Subnet**|
    |起始地址|**10.20.255.0**|
    |启用专用子网（无默认出站访问）|已禁用|

#### 任务 3：实现用于连接到主机池的专用终结点

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器中搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单的“**管理**”部分中，选择“**主机池**”，在“**Azure 虚拟桌面 \| 主机池**”页上，选择 **az140-21-hp1**。 
1. 在 **az140-21-hp1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-hp1 \|网络**”页上，选择“**专用终结点连接**”选项卡，然后选择“**+ 新建专用终结点**”：
1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 资源 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|
    |名称|**az140-11-pehp1**|
    |网络接口名称|**az140-11-pehp1-nic**|
    |区域|部署了 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 虚拟网络 >**”：

    |设置|值|
    |---|---|
    |目标子资源|连接|

1. 在“**创建专用终结点**”页的“**虚拟网络**”选项卡中，指定以下设置并选择“**下一步: DNS >**”（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |虚拟网络|**az140-vnet11e (az140-11e-RG)**|
    |子网|**pe-Subnet**|
    |专用终结点的网络策略|**已禁用**|
    |专用 IP 配置|**动态分配 IP 地址**|

1. 在“**创建专用终结点**”页的“**DNS**”选项卡上，指定以下设置并选择“**下一步: 标签 >**”：

    |设置|值|
    |---|---|
    |与专用 DNS 区域集成|**是**|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|

    > **备注**：此步骤将创建名为 **privatelink.wvd.microsoft.com** 的专用 DNS 区域。

1. 在“**创建专用终结点**”页的“**标记**”选项卡上，选择“**下一步: 查看+创建**”。
1. 在“**创建专用终结点**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > 注意：请等待部署完成。 部署可能需要大约 3 分钟的时间完成。

    > **备注**：需要为要与专用链接配合使用的每个主机池的连接子资源创建专用终结点。

#### 任务 4：实现用于源下载的专用终结点

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上，选择“**工作区**”。
1. 在“**Azure 虚拟桌面 \| 工作区**”页上，选择 **az140-21-ws1**。
1. 在 **az140-21-ws1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-ws1 \| 网络**”页上，选择“**专用终结点连接**”选项卡，然后选择“**+ 新建专用终结点**”：
1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 资源 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|
    |名称|**az140-11-pefeeddwnld**|
    |网络接口名称|**az140-11-pefeeddwnld-nic**|
    |区域|部署了 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 虚拟网络 >**”：

    |设置|值|
    |---|---|
    |目标子资源|**feed**|

1. 在“**创建专用终结点**”页的“**虚拟网络**”选项卡中，指定以下设置并选择“**下一步: DNS >**”（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |虚拟网络|**az140-vnet11e (az140-11e-RG)**|
    |子网|**pe-Subnet**|
    |专用终结点的网络策略|**已禁用**|
    |专用 IP 配置|**动态分配 IP 地址**|

1. 在“**创建专用终结点**”页的“**DNS**”选项卡上，指定以下设置并选择“**下一步: 标签 >**”：

    |设置|值|
    |---|---|
    |与专用 DNS 区域集成|**是**|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|

    > **备注**：此步骤将利用在上一个任务中创建的名为 **privatelink.wvd.microsoft.com** 的专用 DNS 区域。

1. 在“**创建专用终结点**”页的“**标记**”选项卡上，选择“**下一步: 查看+创建**”。
1. 在“**创建专用终结点**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > 注意：请不要等待部署完成，而是继续执行下一个任务。 部署可能需要大约 1 分钟。

    > **备注**：需要为要与专用链接配合使用的每个工作区的源子资源创建专用终结点。

#### 任务 5：实现用于初始源发现的专用终结点

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上，选择“**工作区**”。
1. 在“**Azure 虚拟桌面 \| 工作区**”页上，选择 **az140-21-ws1**。
1. 在 **az140-21-ws1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-ws1 \| 网络**”页上，选择“**专用终结点连接**”选项卡，然后选择“**+ 新建专用终结点**”：
1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 资源 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|
    |名称|**az140-11-pefeeddisc**|
    |网络接口名称|**az140-11-pefeeddisc-nic**|
    |区域|部署了 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“**创建专用终结点**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步: 虚拟网络 >**”：

    |设置|值|
    |---|---|
    |目标子资源|**global**|

1. 在“**创建专用终结点**”页的“**虚拟网络**”选项卡中，指定以下设置并选择“**下一步: DNS >**”（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |虚拟网络|**az140-vnet11e (az140-11e-RG)**|
    |子网|**pe-Subnet**|
    |专用终结点的网络策略|**已禁用**|
    |专用 IP 配置|**动态分配 IP 地址**|

1. 在“**创建专用终结点**”页的“**DNS**”选项卡上，指定以下设置并选择“**下一步: 标签 >**”：

    |设置|值|
    |---|---|
    |与专用 DNS 区域集成|**是**|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|**az140-11e-RG**|

    > **备注**：此步骤将创建名为 **privatelink.wvd.microsoft.com** 的专用 DNS 区域。

1. 在“**创建专用终结点**”页的“**标记**”选项卡上，选择“**下一步: 查看+创建**”。
1. 在“**创建专用终结点**”页的“**查看 + 创建**”选项卡中，选择“**创建**”。

    > 注意：请不要等待部署完成，而是继续执行下一个任务。 部署可能需要大约 1 分钟。

    > **备注**：需要为要与专用链接配合使用的每个工作区的全局子资源创建专用终结点。

    > **备注**：若要使网络更改生效，需要在目标主机池中重启会话主机。

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器中，导航到 **Azure 虚拟桌面**页，在垂直导航菜单的“**管理**”部分中，选择“**主机池**”，然后在“**Azure 虚拟桌面 \| 主机池**”页上选择 **az140-21-hp1**。
1. 在 **az140-21-hp1** 页的垂直导航菜单的“**管理**”部分中，选择“**会话主机**”。 
1. 在会话主机列表中，选择每个会话主机左侧的所有复选框，然后在工具栏中选择“**重启**”。

    > **备注**：等待所有会话主机都处于**运行**状态。 

#### 任务 6：验证专用终结点功能

> **备注**：默认情况下，允许从公用网络连接到 Azure 虚拟桌面工作区和主机池。 首先更改默认设置并执行专用访问。

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上，选择“**工作区**”。
1. 在“**Azure 虚拟桌面 \| 工作区**”页上，选择 **az140-21-ws1**。
1. 在 **az140-21-ws1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-ws1 \| 网络**”页的“**公共访问**”选项卡上，选择“**禁用公共访问并使用专用访问**”选项，然后选择“**保存**”。
1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器中搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单的“**管理**”部分中，选择“**主机池**”，在“**Azure 虚拟桌面 \| 主机池**”页上，选择 **az140-21-hp1**。 
1. 在 **az140-21-hp1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-hp1 \| 网络**”页的“**公共访问**”选项卡上，选择“**禁用公共访问并使用专用访问**”选项，然后选择“**保存**”。

    > **备注**：若要验证专用终结点功能，RDP 客户端需要连接到与 Azure 虚拟网络建立专用连接的网络，该网络包含托管在此实验室前面创建的专用终结点的子网。 为了模拟此方案，你将在用于创建专用终结点的同一虚拟网络中创建另一个子网，并将运行 Windows 11 的 Azure VM 部署到该子网中。

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**虚拟网络**”，然后在“**虚拟网络**”页上，选择 **az140-vnet11e**。
1. 在 **az140-vnet11e** 页上，在垂直导航菜单的“**设置**”部分中，选择“**子网**”。
1. 在“**az140-vnet11e \| 子网**”页中，选择“**+ 子网**”。
1. 在“**添加子网**”窗格中，指定以下设置并选择“**添加**”（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |名称|**client-Subnet**|
    |起始地址|**10.20.2.0**|
    |启用专用子网（无默认出站访问）|已禁用|

1. 在实验室计算机显示Azure 门户的 Web 浏览器中，搜索并选择“**虚拟机**”，在“**虚拟机**”页上，选择“**+ 创建**”，然后在下拉列表中选择“**Azure 虚拟机**”。
1. 在“**创建虚拟机**”页的“**基本信息**”选项卡中，指定以下设置（将其他设置保留为默认值）并选择“**下一步: 磁盘 >**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组名称为 **az140-111e-RG**|
    |虚拟机名称|**az140-111e-vm0**|
    |区域|部署了 Azure 虚拟桌面环境的 Azure 区域的名称|
    |可用性选项|**没有所需的基础结构冗余**|
    |安全类型|**标准**|
    |图像|**Windows 11 专业版，版本 24H2 - x64 Gen2**|
    |大小|**标准 DC2s_v3**|
    |用户名|所选的任何有效用户名|
    |密码|所选的任何有效密码|
    |公共入站端口|**无**|
    |许可|启用复选框|

    > **备注**：密码长度应至少为 12 个字符，由小写字符、大写字符、数字和特殊字符组合而成。 有关详细信息，请参阅[创建 Azure VM 时的密码要求](https://learn.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)。

1. 在“**创建虚拟机**”页的“**磁盘**”选项卡上，将“**OS 磁盘类型**”设置为“**标准 HDD(本地冗余存储)**”，然后选择“**下一步: 网络 >**”。
1. 在“**创建虚拟机**”页的“**网络**”选项卡上，指定以下设置（将其他设置保留为默认值）：

    |设置|值|
    |---|---|
    |虚拟网络|**az140-vnet11e**|
    |子网|**client-Subnet**|
    |公共 IP|**（新）az140-111e-vm0-ip**|
    |NIC 网络安全组|**高级**|

1. 在“**创建虚拟机**”页的“**网络**”选项卡上，选择“**配置网络安全组**”下拉列表旁边的“**新建**”。
1. 在“**创建网络安全组**”页上，删除预先创建的入站规则 **1000: default-allow-rdp**，然后选择“**+ 添加入站规则**”。
1. 在“**添加入站安全规则**”窗格中的“**源**”下拉列表中，选择“**我的 IP 地址**”以标识代表与互联网连接的公共 IP 地址。
1. 在“**添加入站安全规则**”窗格中，指定以下设置（将其他设置保留为默认值），然后选择“**添加**”：

    |设置|值|
    |---|---|
    |源|**IP 地址**|
    |源 IP 地址/CIDR 范围|保持不变（这仍应包含你的公共 IP 地址）|
    |源端口范围|*|
    |目标|**任意**|
    |服务|**RDP**|
    |操作|**允许**|
    |优先级|**300**|
    |名称|**AllowCidrBlockRDPInbound**|

1. 返回到“**创建网络安全组**”页上，选择“**确定**”。
1. 返回“**创建虚拟机**”页的“**网络**”选项卡，选择“**下一步: 管理 >**”：
1. 在“**创建虚拟机**”页的“**管理**”选项卡中，指定以下设置（将其他设置保留为默认值）并选择“**下一步: 监视 >**”：

    |设置|Value|
    |---|---|
    |免费启用基本计划|disabled|
    |补丁业务流程选项|**手动更新**|

1. 在“**创建虚拟机**”页的“**监视**”选项卡中，指定以下设置（其他设置保留默认值）并选择“**查看 + 创建**”：

    |设置|值|
    |---|---|
    |启动诊断|**禁用**|

1. 在“**创建虚拟机**”页的“**查看 + 创建**”选项卡上，选择“**创建**”。

    > 备注：请等待部署完成。 部署可能需要大约 5 分钟时间。

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**虚拟机**”，然后在“**虚拟机**”页上，选择 **az140-111e-vm0**。
1. 在 **az140-111e-vm0** 页上，选择“**连接**”，然后在下拉菜单中，选择“**连接**”。
1. 在“**az140-111e-vm0 \| 连接**”页的“**最常见**”部分中，选择“**下载 RDP 文件**”。
1. 在“**下载**”弹出窗口中，选择“**保留**”，然后选择“**打开文件**”。
1. 出现提示时，选择“**连接**”，然后在“**Windows 安全**”对话框中，输入部署 Azure VM 时指定的用户名和密码。
1. 出现确认提示时，再次选择“**连接**”。
1. 在与 **az140-111e-vm0** 的远程桌面会话中，选择并接受首选隐私设置。
1. 在与 **az140-111e-vm0** 的远程桌面会话中，启动 Microsoft Edge，导航到“[使用适用于 Windows 的远程桌面客户端连接到 Azure 虚拟桌面](https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-windows)”页，向下滚动到“**下载并安装远程桌面客户端 (MSI)**”部分，然后选择 [Windows 64 位](https://go.microsoft.com/fwlink/?linkid=2139369)链接。 
1. 打开文件资源管理器，导航到“**下载**”文件夹，并启动新下载的 MSI 文件的安装。 
1. 出现提示时，接受许可协议的条款并选择“**为本机所有用户安装**”选项。 如果出现提示，请接受用户帐户控制提示以继续安装。 
1. 安装完成后，请确保选中“**安装完成时启动远程桌面**”复选框，然后选择“**完成**”以启动远程桌面客户端。
1. 在与 **az140-111e-vm0** 的远程桌面会话中，在“**远程桌面**”客户端窗口中，选择“**订阅**”，然后在出现提示时，使用 `User2` Entra ID 用户帐户的凭据登录，该帐户可在实验室界面窗口右窗格中的“**资源**”选项卡上找到。

   > **备注**：选择用户帐户，该用户帐户是具有 **AVD-RemoteApp** 前缀的 Entra 组的成员。

1. 确保“**远程桌面**”页显示四个图标，包括命令提示符、Microsoft Word、Microsoft Excel 和 Microsoft PowerPoint。 
1. 双击命令提示符图标。 
1. 当系统提示登录时，在“**Windows 安全**”对话框中，输入用于连接到目标 Azure 虚拟桌面环境的同一 Microsoft Entra 用户帐户的密码。
1. 验证不久后是否会显示**命令提示符**窗口。 
1. 在命令提示符下，键入“logoff”并按 Enter 键以从当前远程应用会话中注销 。

   > **备注**：（可选）可以考虑尝试订阅源并从实验室计算机连接到 Azure 虚拟桌面工作区，以验证此连接是否会失败。 

    > **备注**：若要最小化与运行实验室环境相关的费用，将停止并解除分配新预配的 Azure VM。

#### 任务 7：允许公共网络访问主机池和工作区

1. 在实验室计算机显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上，选择“**工作区**”。
1. 在“**Azure 虚拟桌面 \| 工作区**”页上，选择 **az140-21-ws1**。
1. 在 **az140-21-ws1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“**az140-21-ws1 \| 网络**”页的“**公共访问**”选项卡上，选择“**启用来自所有网络的公共访问**”选项，然后选择“**保存**”。
1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器中搜索并选择“**Azure 虚拟桌面**”，在“**Azure 虚拟桌面**”页的垂直导航菜单的“**管理**”部分中，选择“**主机池**”，在“**Azure 虚拟桌面 \| 主机池**”页上，选择 **az140-21-hp1**。 
1. 在 **az140-21-hp1** 页的垂直导航菜单中的“**设置**”部分，选择“**网络**”。
1. 在“”**az140-21-hp1 \| 网络**”页的“**公共访问**”选项卡上，选择“**启用来自所有网络的公共访问**”选项，然后选择“**保存**”。
