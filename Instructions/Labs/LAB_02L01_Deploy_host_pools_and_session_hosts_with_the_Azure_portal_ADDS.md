---
lab:
  title: 实验室：使用 Azure 门户部署主机池和会话主机 (AD DS)
  module: 'Module 2: Implement an AVD Infrastructure'
---

# 实验室 - 使用 Azure 门户部署主机池和会话主机 (AD DS)
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft 帐户或 Microsoft Entra 帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者或参与者角色，在与该 Azure 订阅关联的 Microsoft Entra 租户中具有全局管理员角色。
- 已完成实验室“准备部署 Azure 虚拟桌面 (AD DS)”

## 预计用时

60 分钟

## 实验室方案

你需要在 Active Directory 域服务 (AD DS) 环境中创建和配置主机池和会话主机。

## 目标
  
完成本实验室后，你将能够：

- 在 AD DS 域中实现 Azure 虚拟桌面环境
- 在 AD DS 域中验证 Azure 虚拟桌面环境

## 实验室文件

- 无

## 说明

### 练习 1：在 AD DS 域中实现 Azure 虚拟桌面环境
  
此练习的主要任务如下：

1. 准备 AD DS 域和 Azure 订阅，以部署 Azure 虚拟桌面主机池
1. 部署 Azure 虚拟桌面主机池
1. 管理 Azure 虚拟桌面主机池会话主机
1. 配置 Azure 虚拟桌面应用程序组
1. 配置 Azure 虚拟桌面工作区

#### 任务 1：准备 AD DS 域和 Azure 订阅，以部署 Azure 虚拟桌面主机池

1. 在实验室计算机上，启动 Web 浏览器，导航到 [Azure 门户]( )，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。
1. 在 Azure 门户中，搜索并选择“虚拟机”，然后在“虚拟机”边栏选项卡中，选择“az140-dc-vm11”  。
1. 在“az140-dc-vm11”边栏选项卡中，选择“连接”，在下拉菜单中选择“Bastion”，在“az140-dc-vm11 \| 连接”边栏选项卡的“Bastion”选项卡中，选择“使用 Bastion”     。
1. 出现提示时，提供以下凭据并选择“连接”：

   |设置|值|
   |---|---|
   |用户名|**学生**|
   |密码|**Pa55w.rd1234**|

1. 在与 az140-dc-vm11 的远程桌面会话中，以管理员身份启动 Windows PowerShell ISE 。
1. 在与 az140-dc-vm11 的远程桌面会话中，从“管理员:  Windows PowerShell ISE”控制台运行以下命令，创建一个组织单位，该组织单位将托管 Azure 虚拟桌面主机的计算机对象：

   ```powershell
   New-ADOrganizationalUnit 'WVDInfra' –path 'DC=adatum,DC=com' -ProtectedFromAccidentalDeletion $false
   ```

1. 在“管理员:Windows PowerShell ISE”控制台中运行以下命令，以登录 Azure 订阅：

   ```powershell
   Connect-AzAccount
   ```

1. 如果出现提示，请提供具有本实验室所用订阅的所有者角色的用户帐户的凭据。
1. 在“管理员:Windows PowerShell ISE”控制台，运行以下命令，以标识 aduser1 帐户的用户主体名称：

   ```powershell
   (Get-AzADUser -DisplayName 'aduser1').UserPrincipalName
   ```

   > **注意**：请记录你在此步骤中标识的用户主体名称。 本实验室中稍后会用到它。

1. 在“管理员:Windows PowerShell ISE”控制台运行以下命令，以注册 Microsoft.DesktopVirtualization 资源提供程序：

   ```powershell
   Register-AzResourceProvider -ProviderNamespace Microsoft.DesktopVirtualization
   ```

1. 在与 az140-dc-vm11 的远程桌面会话中，启动 Microsoft Edge，并导航到 [Azure 门户](https://portal.azure.com)。 如果出现提示，请使用在本实验室所用订阅中具有所有者角色的用户帐户的 Microsoft Entra 凭据登录。
1. 在与 az140-dc-vm11 的远程桌面会话中，在 Azure 门户中，使用 Azure 门户页顶部的“搜索资源、服务和文档”文本框，搜索并导航到“虚拟网络”，然后在“虚拟网络”边栏选项卡中选择“az140-adds-vnet11”    。 
1. 在“az140-adds-vnet11”边栏选项卡上，选择“子网”，在“子网”边栏选项卡中选择“+ 子网”，在“添加子网”边栏选项卡上，指定以下设置（所有其他设置保留默认值），并单击“保存”     ：

   |设置|值|
   |---|---|
   |名称|hp1-Subnet|
   |子网地址范围|**10.0.1.0/24**|

#### 任务 2：部署 Azure 虚拟桌面主机池

1. 在与 az140-dc-vm11 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口，搜索并选择“Azure 虚拟桌面”，在“Azure 虚拟桌面”边栏选项卡上，选择“主机池”，在“Azure 虚拟桌面 \| 主机池”边栏选项卡上，选择“+ 创建”     。 
1. 在“创建主机池”边栏选项卡的“基本信息”选项卡上，指定以下设置并选择“下一步:  虚拟机 >”（其他设置保留默认值）：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|新资源组名称 az140-21-RG|
   |主机池名称|az140-21-hp1|
   |位置|在本实验室的第一个练习中将资源部署到其中的 Azure 区域的名称，或一个靠近该区域的区域的名称 |
   |验证环境|**否**|
   |首选应用组类型|**桌面**|
   |主机池类型|**池**|
   |负载均衡算法|**广度优先**|
   |最大会话限制|**12**|

1. 在“创建主机池”边栏选项卡的“虚拟机”选项卡中，指定以下设置并选择“下一步:  工作区 >”（其他设置保留默认值）：

   |设置|值|
   |---|---|
   |添加 Azure 虚拟机|**是**|
   |资源组|默认与主机池相同|
   |名称前缀|az140-21-p1|
   |虚拟机位置|在本实验室的第一个练习中，将资源部署到其中的 Azure 区域的名称|
   |可用性选项|**没有所需的基础结构冗余**|
   |安全类型|**标准**|
   |映像|**Windows 11 企业版多会话 + Microsoft 365 应用版，版本 22H2**|
   |虚拟机大小|Standard D2s v3|
   |VM 数量|**2**|
   |OS 磁盘类型|**标准 SSD**|
   |启动诊断|使用托管存储帐户启用（推荐）|
   |虚拟网络|az140-adds-vnet11|
   |子网|hp1-Subnet (10.0.1.0/24)|
   |网络安全组|**基本**|
   |公共入站端口|**否**|
   |选择要加入的目录|**Active Directory**|
   |AD 域加入 UPN|**student@adatum.com**|
   |密码|**Pa55w.rd1234**|
   |指定域或单元|**是**|
   |要加入的域|adatum.com|
   |组织单位路径|OU=WVDInfra,DC=adatum,DC=com|
   |用户名|**学生**|
   |密码|**Pa55w.rd1234**|
   |确认密码|**Pa55w.rd1234**|

1. 在“创建主机池”边栏选项卡的“工作区”选项卡中，指定以下设置并选择“查看 + 创建”  ：

   |设置|Value|
   |---|---|
   |注册桌面应用组|**否**|

1. 在“创建主机池”边栏选项卡的“查看 + 创建”选项卡中，选择“创建”  。

   > 备注：请等待部署完成。 这可能需要大约 10 分钟。

#### 任务 3：管理 Azure 虚拟桌面主机池会话主机

1. 在与 az140-dc-vm11 的远程桌面会话中，在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择“Azure 虚拟桌面”，在“Azure 虚拟桌面”边栏选项卡上，在垂直菜单栏的“管理部分”中，选择“主机池”    。
1. 在“Azure 虚拟桌面 \| 主机池”边栏选项卡的主机池列表中，选择“az140-21-hp1” 。
1. 在“az140-21-hp1”边栏选项卡上，在垂直菜单栏的“管理部分”中，选择“会话主机”，然后验证池是否由两个主机组成  。 
1. 在“az140-21-hp1 \| 会话主机”边栏选项卡上，选择“+ 添加” 。
1. 在“将虚拟机添加到主机池”边栏选项卡的“基本信息”选项卡中，查看预配置的设置并选择“下一步:  虚拟机“。
1. 在“将虚拟机添加到主机池”边栏选项卡的“虚拟机”选项卡中，指定以下设置并选择“查看 + 创建”（其他设置保留默认值）  ：

   |设置|值|
   |---|---|
   |资源组|az140-21-RG|
   |名称前缀|az140-21-p1|
   |虚拟机位置|将前两个会话主机 VM 部署到其中的 Azure 区域的名称|
   |可用性选项|**没有所需的基础结构冗余**|
   |安全类型|**标准**|
   |映像|**Windows 11 企业版多会话 + Microsoft 365 应用版，版本 22H2**|
   |VM 数量|**1**|
   |OS 磁盘类型|**标准 SSD**|
   |启动诊断|使用托管存储帐户启用（推荐）|
   |虚拟网络|az140-adds-vnet11|
   |子网|hp1-Subnet (10.0.1.0/24)|
   |网络安全组|**基本**|
   |公共入站端口|**否**|
   |AD 域加入 UPN|**student@adatum.com**|
   |密码|**Pa55w.rd1234**|
   |指定域或单元|**是**|
   |要加入的域|adatum.com|
   |组织单位路径|OU=WVDInfra,DC=adatum,DC=com|   
   |虚拟机管理员帐户用户名|**学生**|
   |虚拟机管理员帐户密码|**Pa55w.rd1234**|

   > **注意**：正如你可能注意到的，在将会话主机添加到现有池时，可以更改 VM 的映像和前缀。 通常，除非计划替换池中的所有 VM，否则不建议这样做。 

1. 在“将虚拟机添加到主机池”边栏选项卡的“查看 + 创建”选项卡中，选择“创建”

   > **注意**：在继续下一个任务之前，请等待部署完成。 部署可能需要大约 5 分钟时间。 

#### 任务 4：配置 Azure 虚拟桌面应用程序组

1. 在与 az140-dc-vm11 的远程桌面会话中，在显示 Azure 门户的 Web 浏览器窗口中，搜索并选择“Azure 虚拟桌面”，在“Azure 虚拟桌面”边栏选项卡上，选择“应用程序组”   。
1. 在“Azure 虚拟桌面 \| 应用程序组”边栏选项卡上，注意现有的自动生成的 az140-21-hp1-DAG 桌面应用程序组，并选择它 。 
1. 在“az140-21-hp1-DAG”边栏选项卡中，选择“分配” 。
1. 在“az140-21-hp1-DAG \| 分配”边栏选项卡上，选择“+ 添加” 。
1. 在“选择 Microsoft Entra 用户或用户组”**** 边栏选项卡上，选择“az140-wvd-pooled”****，然后单击“选择”****。
1. 导航回“Azure 虚拟桌面 \| 应用程序组”边栏选项卡，选择“+ 创建” 。 
1. 在“创建应用程序组”边栏选项卡的“基本信息”选项卡中，指定以下设置并选择“下一步:  应用程序 >”：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|az140-21-RG|
   |主机池|az140-21-hp1|
   |应用程序组类型|**远程应用 (RAIL)**|
   |应用程序组名称|az140-21-hp1-Office365-RAG|

1. 在“创建应用程序组”边栏选项卡的“应用程序”选项卡中，选择“+ 添加应用程序”。
1. 在“添加应用程序”边栏选项卡上，指定以下设置并选择“保存” ：

   |设置|值|
   |---|---|
   |应用程序源|**“开始”菜单**|
   |应用程序|**Word**|
   |说明|**Microsoft Word**|
   |需要命令行|**否**|

1. 返回“创建应用程序组”边栏选项卡的“应用程序”选项卡中，选择“+ 添加应用程序”  。
1. 在“添加应用程序”边栏选项卡上，指定以下设置并选择“保存” ：

   |设置|值|
   |---|---|
   |应用程序源|**“开始”菜单**|
   |应用程序|**Excel**|
   |说明|**Microsoft Excel**|
   |需要命令行|**否**|

1. 返回“创建应用程序组”边栏选项卡的“应用程序”选项卡中，选择“+ 添加应用程序”  。
1. 在“添加应用程序”边栏选项卡上，指定以下设置并选择“保存” ：

   |设置|值|
   |---|---|
   |应用程序源|**“开始”菜单**|
   |应用程序|**PowerPoint**|
   |说明|**Microsoft PowerPoint**|
   |需要命令行|**否**|

1. 返回“创建应用程序组”边栏选项卡的“应用程序”选项卡，选择“下一步:  分配 >”。
1. 在“创建应用程序组”**** 边栏选项卡的“分配”**** 选项卡上，选择“+ 添加 Microsoft Entra 用户或用户组”****。
1. 在“选择 Microsoft Entra 用户或用户组”**** 边栏选项卡上，选择“az140-wvd-remote-app”****，然后单击“选择”****。
1. 返回“创建应用程序组”边栏选项卡的“分配”选项卡中，选择“下一步:  工作区 >”。
1. 在“创建工作区”边栏选项卡的“工作区”选项卡中，指定以下设置并选择“查看 + 创建”  ：

   |设置|Value|
   |---|---|
   |注册应用程序组|**否**|

1. 在“创建应用程序组”边栏选项卡的“查看 + 创建”选项卡中，选择“创建”  。

   > **注意**：等待应用程序组创建完成。 此过程应该会在 1 分钟内完成。 

   > **注意**：接下来，你将基于作为应用程序源的文件路径创建一个应用程序组。

1. 在与 az140-dc-vm11 的远程桌面会话中，搜索并选择“Azure 虚拟桌面”，在“Azure 虚拟桌面”边栏选项卡上，选择“应用程序组”   。
1. 在“Azure 虚拟桌面 \| 应用程序组”边栏选项卡上，选择“+ 创建” 。 
1. 在“创建应用程序组”边栏选项卡的“基本信息”选项卡中，指定以下设置并选择“下一步:  应用程序 >”：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|az140-21-RG|
   |主机池|az140-21-hp1|
   |应用程序组类型|**RemoteApp (RAIL)**|
   |应用程序组名称|az140-21-hp1-Utilities-RAG|

1. 在“创建应用程序组”边栏选项卡的“应用程序”选项卡中，选择“+ 添加应用程序”。
1. 在“添加应用程序”边栏选项卡上，使用“基本信息”和“索引”选项卡指定以下设置并选择“保存”****************：

   |设置|值|
   |---|---|
   |应用程序源|**文件路径**|
   |应用程序路径|**C:\Windows\system32\cmd.exe**|
   |应用程序名称|**命令提示符**|
   |显示名称|**命令提示符**|
   |图标路径|**C:\Windows\system32\cmd.exe**|
   |图标索引|**0**|
   |说明|Windows 命令提示符|
   |需要命令行|**否**|

1. 返回“创建应用程序组”边栏选项卡的“应用程序”选项卡，选择“下一步:  分配 >”。
1. 在“创建应用程序组”**** 边栏选项卡的“分配”**** 选项卡上，选择“+ 添加 Microsoft Entra 用户或用户组”****。
1. 在“选择 Microsoft Entra 用户或用户组”**** 边栏选项卡上，选择“az140-wvd-remote-app”**** 和“az140-wvd-admins”****，然后单击“选择”****。
1. 返回“创建应用程序组”边栏选项卡的“分配”选项卡中，选择“下一步:  工作区 >”。
1. 在“创建工作区”边栏选项卡的“工作区”选项卡中，指定以下设置并选择“查看 + 创建”  ：

   |设置|Value|
   |---|---|
   |注册应用程序组|**否**|

1. 在“创建应用程序组”边栏选项卡的“查看 + 创建”选项卡中，选择“创建”  。

#### 任务 5：配置 Azure 虚拟桌面工作区

1. 在与 az140-dc-vm11 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，搜索并选择“Azure 虚拟桌面”，在“Azure 虚拟桌面”边栏选项卡上，选择“工作区”   。
1. 在“Azure 虚拟桌面 \| 工作区”边栏选项卡上，选择“+ 创建” 。 
1. 在“创建工作区”边栏选项卡的“基本信息”选项卡中，指定以下设置并选择“下一步:  应用程序组 >”：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|az140-21-RG|
   |工作区名称|az140-21-ws1|
   |友好名称|az140-21-ws1|
   |位置|在本实验室的第一个练习中将资源部署到其中的 Azure 区域的名称，或一个靠近该区域的区域的名称|

1. 在“创建工作区”边栏选项卡的“应用程序组”选项卡上，指定以下设置 ：

   |设置|值|
   |---|---|
   |注册应用程序组|**是**|

1. 在“创建工作区”边栏选项卡的“工作区”选项卡中，选择“+ 注册应用程序组”  。
1. 在“添加应用程序组”边栏选项卡上，选择“az140-21-hp1-DAG”、“az140-21-hp1-Office365-RAG”和“az140-21-hp1-Utilities-RAG”条目旁的加号，然后单击“选择”    。 
1. 返回到“创建工作区”边栏选项卡中的“应用程序组”选项卡，选择“查看 + 创建”  。
1. 在“创建工作区”边栏选项卡的“查看 + 创建”选项卡中，选择“创建”  。

### 练习 2：验证 Azure 虚拟桌面环境
  
此练习的主要任务如下：

1. 在 Windows 10 计算机上安装 Microsoft 远程桌面客户端 (MSRDC)
1. 订阅 Azure 虚拟桌面工作区
1. 测试 Azure 虚拟桌面应用

#### 任务 1：在 Windows 10 计算机上安装 Microsoft 远程桌面客户端 (MSRDC)

1. 在与 az140-dc-vm11 的远程桌面会话中，在显示 Azure 门户的浏览器窗口中，搜索并选择“虚拟机”，并在“虚拟机”边栏选项卡上，选择“az140-cl-vm11”条目   。
1. 在“az140-cl-vm11”边栏选项卡上，向下滚动到“操作”部分，然后选择“运行命令”  。 
1. 在“az140-cl-vm11 \| 运行命令”边栏选项卡上，选择“EnableRemotePS”，然后选择“运行”  。 

   > **注意**：请等待命令运行完成，再继续下一步。 这大约需要 1 分钟。 你可能会收到红色文本错误，其中指出使用的是公共配置文件而不是域配置文件，如果是这样，可以忽略并转到下一步。

1. 在与 az140-dc-vm11 的远程桌面会话中，从“管理员:  **Windows PowerShell ISE”脚本窗格中运行以下命令，将 ADATUM\\az140-wvd-users 的所有成员添加到本地“远程桌面用户”组，该组位于运行你在实验室“准备部署 Azure 虚拟桌面 (AD DS)”中部署的 Windows 10 的 Azure VM az140-cl-vm11 上**    。

   ```powershell
   $computerName = 'az140-cl-vm11'
   Invoke-Command -ComputerName $computerName -ScriptBlock {Add-LocalGroupMember -Group 'Remote Desktop Users' -Member 'ADATUM\az140-wvd-users'}
   ```

1. 切换到你的实验室计算机，在该实验室计算机的显示 Azure 门户的浏览器窗口中，搜索并选择“虚拟机”，然后在“虚拟机”边栏选项卡上，选择“az140-cl-vm11”条目  。
1. 在“az140-cl-vm11”边栏选项卡中，选择“连接”，在下拉菜单中选择“Bastion”，在“az140-cl-vm11 \| 连接”边栏选项卡的“Bastion”选项卡中，选择“使用 Bastion”     。
1. 出现提示时，提供以下凭据并选择“连接”：

   |设置|值|
   |---|---|
   |用户名|**Student@adatum.com**|
   |密码|**Pa55w.rd1234**|

1. 在与 az140-cl-vm11 的远程桌面会话中，启动 Microsoft Edge，并导航到 [Windows 桌面客户端下载页](https://go.microsoft.com/fwlink/?linkid=2068602)，然后在出现提示时，选择“运行”以启动安装 。 在“远程桌面安装”向导的“安装范围”页上，选择“为此计算机的所有用户安装”选项，然后单击“安装”   。 如果用户帐户控制提示输入管理凭据，请使用 ADATUM\\Student 用户名并将 Pa55w.rd1234 作为密码进行身份验证 。
1. 安装完成后，请确保“安装完成时启动远程桌面”复选框处于选中状态，然后单击“完成”以启动“远程桌面客户端” 。

#### 任务 2：订阅 Azure 虚拟桌面工作区

1. 在“远程桌面”客户端窗口中，选择“订阅”，然后在出现提示时，通过提供之前在本实验室中标识的 userPrincipalName 和在创建此帐户时设置的密码，使用 aduser1 凭据进行登录  。

   > **注意**：或者，在“远程桌面”客户端窗口中，选择“通过 URL 订阅”，在“订阅工作区”窗格中的“电子邮件或工作区 URL”中，键入 https://rdweb.wvd.microsoft.com/api/arm/feeddiscovery ，选择“下一步”，然后在出现提示时，使用 aduser1 凭据（使用其 userPrincipalName 属性作为用户名和在创建此帐户时设置的密码）进行登录      。 

1. 如果收到提示，在“保持登录到所有应用”窗口中，清除“允许组织管理我的设备”复选框，然后选择“否，仅登录到此应用”  。 
1. 确保“远程桌面”页显示发布到工作区的应用程序组中包含的且通过其组成员资格与用户帐户 aduser1 关联的应用程序列表 。 

#### 任务 3：测试 Azure 虚拟桌面应用

1. 在与 az140-cl-vm11 的远程桌面会话中，在“远程桌面”客户端窗口的应用程序列表中，双击“命令提示符”，然后验证其是否启动了“命令提示符”窗口   。 提示进行身份验证时，输入在创建 aduser1 用户帐户时设置的密码，选中“记住我”复选框，然后选择“确定”  。

   > **注意**：最开始应用程序可能需要几分钟才能启动，但之后启动速度应该会快得多。

   > 注意：如果看到“欢迎使用 Microsoft Teams”登录提示，请将其关闭。

1. 在命令提示符下，键入主机名并按 Enter 键以显示运行命令提示符的计算机的名称 。

   > **注意**：验证显示的名称为 az140-21-p1-0、az140-21-p1-1 或 az140-21-p1-2，而不是 az140-cl-vm11   。

1. 在命令提示符下，键入“logoff”并按 Enter 键以从当前远程应用会话中注销 。
1. 在与 az140-cl-vm11 的远程桌面会话中，在“远程桌面”客户端窗口的应用程序列表中，双击“SessionDesktop”，然后验证其是否启动了远程桌面会话  。 
1. 在“默认桌面”会话中，右键单击“开始”，选择“运行”，在“运行”对话框的“打开”文本框中，键入“cmd”并选择“确定”      。 
1. 在“默认桌面”会话的命令提示符下，键入“主机名”并按 Enter 键以显示运行远程桌面会话的计算机的名称  。
1. 验证显示的名称是否为 az140-21-p1-0、az140-21-p1-1 或 az140-21-p1-2  。

### 练习 3：停止并解除分配在实验室中预配的 Azure VM

此练习的主要任务如下：

1. 停止并解除分配在实验室中预配的 Azure VM

>**注意**：在此练习中，你将解除分配此实验室中预配的 Azure VM，以最大程度减少相应的计算费用

#### 任务 1：解除分配在实验室中预配的 Azure VM

1. 切换到实验室计算机，然后在显示 Azure 门户的 Web 浏览器窗口中，打开 Cloud Shell 窗格内的“PowerShell”shell 会话 。
1. 在“Cloud Shell”窗格中的 PowerShell 会话中，运行以下命令以列出本实验室中创建的所有 Azure VM：

   ```powershell
   Get-AzVM -ResourceGroup 'az140-21-RG'
   ```

1. 在“Cloud Shell”窗格中的 PowerShell 会话中，运行以下命令以停止和解除分配本实验室中创建的所有 Azure VM：

   ```powershell
   Get-AzVM -ResourceGroup 'az140-21-RG' | Stop-AzVM -NoWait -Force
   ```

   >**注意**：该命令异步执行（由 -NoWait 参数确定），因此尽管此后可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上也要花几分钟才能停止和解除分配 Azure VM。
