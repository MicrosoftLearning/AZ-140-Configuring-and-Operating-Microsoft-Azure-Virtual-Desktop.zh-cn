---
lab:
  title: 实验室：使用 Azure Virtual Desktop Insights 实现监视
  module: 'Module 4.1: Monitor and manage Azure Virtual Desktop services'
---

# 实验室 - 使用 Azure Virtual Desktop Insights 实现监视
# 学生实验室手册

## 实验室依赖项

- 本实验室将使用的 Azure 订阅。
- Microsoft Entra 用户帐户，该帐户在本实验室将会使用的 Azure 订阅中具有所有者或参与者角色，在与该 Azure 订阅关联的 Entra 租户中具有足够加入设备的权限。
- 已完成实验室*使用 Azure 门户部署主机池和会话主机 (Entra ID)*
- 已完成实验室“*使用 Azure 门户 (Entra ID) 管理主机池和会话主机*”

## 估计时间

25 分钟

## 实验室方案

你有一个现成的 Azure 虚拟桌面环境。 你想要监视环境的状态和活动。

## 目标
  
完成本实验室后，你将能够：

- 实现对 Azure 虚拟桌面环境的监视

## 实验室文件

- 无

## 说明

### 练习 1：实现对 Azure 虚拟桌面环境的监视
  
此练习的主要任务如下：

1. 向 Microsoft.Insights 资源提供程序注册 Azure 订阅
1. 创建一个 Azure Log Analytics 工作区
1. 设置 Virtual Desktop Insights 配置工作簿

#### 任务 1：向 Microsoft.Insights 资源提供程序注册 Azure 订阅

> **备注**：Azure Virtual Desktop Insights 依赖于 Microsoft.Insights 资源提供程序，因此需要先在用于此实验室的 Azure 订阅中对其进行注册。 在*使用 Azure 门户部署主机池和会话主机 (Entra ID)* 实验室中，使用 Azure PowerShell 执行此任务。 在此实验室中，你将通过 Azure 门户（任一方法均受支持且可用）来完成此操作。

1. 如果需要，在实验室计算机上，启动 Web 浏览器，导航到 Azure 门户，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据进行登录。

    > **备注**：使用实验室会话窗口右侧“资源”选项卡上列出的 `User1-` 帐户的凭据。

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**订阅**”，在“**订阅**”页上，选择正在本实验室中使用的 Azure 订阅，然后在“**设置**”部分的垂直导航菜单中，选择“**资源提供程序**”。
1. 在“**资源提供程序**”选项卡上的搜索文本框中，输入“**Microsoft.Insights**”，在结果列表中选择“**Microsoft.Insights**”条目左侧的小圆圈，然后选择“**注册**”。

    > **备注**：等待注册过程完成。 这通常需要约 1 分钟时间。 使用“**刷新**”工具栏按钮显示注册状态的最新值。

#### 任务 2：创建一个 Log Analytics 工作区

> **备注**：Azure Virtual Desktop Insights 是基于 Azure Monitor 工作簿构建的仪表板，可帮助监视 Azure 虚拟桌面环境。 

> **备注**：只能使用共用主机池通过 Insights 监视自动缩放操作。 

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中搜索并选择“**Log Analytics 工作区**”，然后在“**Log Analytics 工作区**”页上选择“**+ 创建**”。
1. 在“**创建 Log Analytics 工作区**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**查看 + 创建**”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|新资源组的名称 **az140-411e-RG**|
    |名称|**az140-laworkspace41e**|
    |区域|部署 Azure 虚拟桌面环境的 Azure 区域的名称|

1. 在“查看 + 创建”页上，选择“创建”。

    > **注意**：等待预配过程完成。 这通常需要约 1 分钟时间。

    > **备注**：接下来，需要在 Azure 虚拟桌面环境中用于诊断的新预配 Log Analytics 工作区、会话主机中的性能计数器和 Azure 虚拟桌面会话主机中的 Windows 事件日志中启用数据收集。

#### 任务 3：设置 Virtual Desktop Insights 配置工作簿

> **备注**：第一次打开 Azure Virtual Desktop Insights 时，你需要将 Azure Virtual Desktop Insights 设置为面向 Azure 虚拟桌面环境。

1. 在实验室计算机中，在显示 Azure 门户的 Web 浏览器中，搜索并选择“**Azure 虚拟桌面**”，然后在“**Azure 虚拟桌面**”页上的垂直导航菜单中的“**监视**”部分中，选择“**工作簿**”。
1. 在“**Windows 虚拟桌面**”部分的“**Windows 虚拟桌面**”工作簿列表中，选择“**Insights**”工作簿。
1. 在“**Azure 虚拟桌面 \| 工作簿 \| Insights**”页上，查看警告消息，该消息指示工作区和会话主机未将数据发送到工作区，然后选择“**配置工作簿**”链接来修复问题。
1. 在“**CheckAMAConfiguration**”页上“**资源诊断设置**”选项卡的“**Log Analytics 工作区**”下拉列表中，选择 **az140-laworkspace41e**。
1. 在“**CheckAMAConfiguration**”页上的“**资源诊断设置**”选项卡的“**主机池 az140-21-hp1**”部分中，查看警告消息，该消息指示找不到所选主机池的现有诊断配置，然后选择“**配置主机池**”。
1. 在“**导出模板**”窗格中选择“**部署**”。

    > **备注**：这将有效地在目标 Log Analytics 工作区中启用以下诊断表：
    - 管理活动
    - 源
    - 连接
    - 错误
    - 检查点
    - HostRegistration
    - AgentHealthStatus

    > 备注：请等待部署完成。 这通常需要不到 1 分钟。

1. 在“**CheckAMAConfiguration**”页上的“**资源诊断设置**”选项卡中，选择工具栏中的“**刷新**”图标（圆形箭头）。
1. 查看“**主机池 az140-21-hp1**”部分，并验证是否已为“**allLogs**”启用诊断设置。
1. 在“**资源诊断设置**”选项卡上，向下滚动到“**工作区 az140-21-ws1**”部分，然后选择“**配置工作区**”。
1. 在“**导出模板**”窗格中选择“**部署**”。

    > **备注**：这将有效地配置“**allLogs**”的工作区。

    > 备注：请等待部署完成。 这通常需要不到 1 分钟。

1. 在“**CheckAMAConfiguration**”页上的“**资源诊断设置**”选项卡中，选择工具栏中的“**刷新**”图标（圆形箭头）。
1. 查看“**Workspace az140-21-ws1**”部分，并验证是否为“**allLogs**”启用了诊断设置，且没有剩余的警告消息。
1. 导航到“**CheckAMAConfiguration**”页面顶部，并切换到“**选择主机数据设置**”选项卡。
1. 在“**选择主机数据设置**”选项卡上，在“**创建 DCR**”部分的“**工作区目标**”下拉列表中，选择 **az140-laworkspace41e**，然后选择“**创建数据收集规则**”。
1. 在“**导出模板**”窗格中选择“**部署**”。

    > 备注：请等待部署完成。 这通常需要不到 1 分钟。

1. 在 **CheckAMAConfiguration** 页上的“**会话主机数据设置**”选项卡上，选择工具栏中的“**刷新**”图标（圆形箭头）。

    > **备注**：在继续操作之前，请确保新创建的 DCR 在“**创建 DCR**”部分的“**可用 DCR**”子部分中列出。 如果没有列出，请等待一分钟，然后再次刷新页面。

1. 在“**会话主机数据设置**”选项卡上的“**所选 DCR**”下拉列表中，选择以 **microsoft-avdi-** 前缀开头的条目。
1. 如果需要，在 **“会话主机数据设置”** 选项卡上的 **“DCR 关联**”部分中，选择“**部署关联**”，然后在“**部署模板**”窗格中选择“**部署**”。

    > **备注**：这可有效地将新创建的 DCR 与 **az140-21-hp1** 主机池中的会话主机相关联。

    > 备注：请等待部署完成。 这通常需要不到 1 分钟。

1. 在 **CheckAMAConfiguration** 页上的“**会话主机数据设置**”选项卡上，选择工具栏中的“**刷新**”图标（圆形箭头）。
1. 在“**会话主机数据设置**”选项卡上的“**会话主机缺少 Azure Monitor 扩展**”部分，选择“**添加扩展**”。
1. 在“**导出模板**”窗格中选择“**部署**”。

    > **备注**：这将有效地在 **az140-21-hp1** 主机池中的会话主机上安装 Azure Monitor 扩展。

    > 备注：请等待部署完成。 这大约需要 1 分钟。

1. 在 **CheckAMAConfiguration** 页上的“**会话主机数据设置**”选项卡上，选择工具栏中的“**刷新**”图标（圆形箭头）。
1. 验证是否未显示错误或警告消息。 
1. 导航到 **CheckAMAConfiguration** 页面顶部，选择“**生成的数据**”选项卡，然后选择工具栏中的“**刷新**”图标（圆形箭头）。
1. 查看显示图形（这些图形代表所收集的数据）的部分，包括“**过去 24 小时内的计费数据**”、“**性能计数器**”和“**事件**”。

    > **注意**：使用“**过去 24 小时内的计费数据**”部分监视数据引入。 你负责承担数据存储和引入的 Log Analytics 费用。

1. 在显示 Azure 门户的 Web 浏览器中，导航回“**Azure 虚拟桌面**”页，然后在垂直导航菜单的“**监控**”部分，选择“**见解**”。
1. 在“**Azure 虚拟桌面\|见解**”页上，查看“**概述**”选项卡的内容，包括“**容量**”部分、“**连接诊断: 能够连接的用户百分比**”、“**连接性能: 连接时间(新会话)**”和“**利用率**”遥测数据。 
1. 接下来，查看“**Azure 虚拟桌面\|见解**”页上的所有剩余选项卡，包括“**连接可靠性**”、“**连接诊断**”、“**连接性能**”、“**用户**”、“**利用率**”、“**客户端**”和“**警报**”。

    > **注意**：在完成后续实验室后，请考虑重新访问“见解”页的这些选项卡，以查看表示所收集遥测数据的图表。
